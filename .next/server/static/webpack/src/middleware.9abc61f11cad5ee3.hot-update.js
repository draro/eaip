"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("src/middleware",{

/***/ "(middleware)/./src/middleware.ts":
/*!***************************!*\
  !*** ./src/middleware.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__)\n/* harmony export */ });\n/* harmony import */ var next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next-auth/middleware */ \"(middleware)/./node_modules/next-auth/middleware.js\");\n/* harmony import */ var next_auth_middleware__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/server */ \"(middleware)/./node_modules/next/dist/esm/api/server.js\");\n/* harmony import */ var _lib_domain__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/domain */ \"(middleware)/./src/lib/domain.ts\");\n\n\n\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__.withAuth)(async function middleware(req) {\n    const { pathname } = req.nextUrl;\n    const token = req.nextauth.token;\n    // Get hostname from X-Forwarded-Host (Nginx proxy) or fall back to req.nextUrl.hostname\n    const forwardedHost = req.headers.get(\"x-forwarded-host\") || req.headers.get(\"host\") || \"\";\n    const hostname = req.headers.get(\"x-forwarded-host\") || req.headers.get(\"host\") || new URL(req.url).hostname;\n    const protocol = req.headers.get(\"x-forwarded-proto\") || \"https\";\n    const nextUrl = new URL(req.nextUrl.pathname, `${protocol}://${forwardedHost}`);\n    console.log(`[Middleware] Request: ${hostname}${req.nextUrl.pathname}`, {\n        \"x-forwarded-host\": req.headers.get(\"x-forwarded-host\"),\n        host: req.headers.get(\"host\"),\n        \"nextUrl.hostname\": nextUrl.hostname\n    });\n    // Skip processing for localhost and development\n    if (!req.headers.get(\"x-middleware-request\") && (hostname === \"localhost\" || forwardedHost.includes(\"localhost\"))) {\n        console.log(\"[Middleware] Skipping external localhost\");\n        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next();\n    }\n    // Simple domain extraction\n    const cleanDomain = forwardedHost.toLowerCase().replace(/^www\\./, \"\");\n    // Check if this is a custom domain (not our main application domains)\n    const mainAppDomain = process.env.NEXTAUTH_URL?.replace(/^https?:\\/\\//, \"\").split(\"/\")[0] || \"eaip.flyclim.com\";\n    const isMainDomain = hostname === mainAppDomain || hostname === \"eaip.flyclim.com\" || // Always treat eaip.flyclim.com as main domain\n    hostname === \"localhost\" || hostname === \"0.0.0.0\" || hostname.includes(\"localhost\") || hostname.includes(\"vercel.app\") || hostname.includes(\"netlify.app\");\n    console.log(`[Middleware] Domain check:`, {\n        hostname,\n        cleanDomain,\n        mainAppDomain,\n        isMainDomain\n    });\n    // Handle tenant-specific domain routing\n    if (!isMainDomain && cleanDomain !== \"localhost\") {\n        try {\n            // For custom domains, use an API call to lookup organization\n            // Use localhost for internal API calls to avoid SSL issues\n            const internalOrigin = \"http://localhost:3000\";\n            const domainLookupUrl = new URL(\"/api/organizations/by-domain\", internalOrigin);\n            domainLookupUrl.searchParams.set(\"domain\", cleanDomain);\n            console.log(\"[Middleware] Fetching org data from:\", domainLookupUrl.toString());\n            const domainResponse = await fetch(domainLookupUrl.toString(), {\n                headers: {\n                    \"x-middleware-request\": \"true\"\n                }\n            });\n            if (domainResponse.ok) {\n                const domainData = await domainResponse.json();\n                if (domainData.success && domainData.organization) {\n                    // Set organization context headers\n                    const requestHeaders = new Headers(req.headers);\n                    requestHeaders.set(\"x-tenant-domain\", cleanDomain);\n                    requestHeaders.set(\"x-tenant-org-id\", domainData.organization._id);\n                    requestHeaders.set(\"x-tenant-org-name\", domainData.organization.name);\n                    // For authenticated users, validate they belong to this organization\n                    if (token) {\n                        const userOrgId = token.organizationId;\n                        const domainOrgId = domainData.organization._id;\n                        // Block cross-tenant access\n                        if (!_lib_domain__WEBPACK_IMPORTED_MODULE_2__.DomainService.validateUserAccess(userOrgId, domainOrgId) && !pathname.startsWith(\"/auth/signin\")) {\n                            console.log(`Access denied: User org ${userOrgId} accessing domain org ${domainOrgId}`);\n                            // Redirect to domain-specific login\n                            const loginUrl = new URL(\"/auth/signin\", req.url);\n                            loginUrl.searchParams.set(\"error\", \"unauthorized\");\n                            loginUrl.searchParams.set(\"callbackUrl\", pathname);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(loginUrl);\n                        }\n                    }\n                    // Custom domains ONLY serve public pages\n                    // Redirect all custom domain traffic to public eAIP pages\n                    const url = req.nextUrl.clone();\n                    const orgDomain = domainData.organization.domain;\n                    // Map root to public organization page\n                    if (pathname === \"/\") {\n                        url.pathname = `/public/${orgDomain}`;\n                        console.log(`[Custom Domain] Root rewrite: ${hostname}/ → ${url.pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Map document IDs directly to public document pages\n                    // Pattern: /{documentId} → /public/{domain}/{documentId}\n                    const documentIdPattern = /^\\/([a-f0-9]{24})$/i; // MongoDB ObjectId pattern\n                    if (documentIdPattern.test(pathname)) {\n                        url.pathname = `/public/${orgDomain}${pathname}`;\n                        console.log(`[Custom Domain] Document rewrite: ${hostname}${pathname} → ${url.pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Handle /public routes on custom domains\n                    if (pathname.startsWith(\"/public\")) {\n                        // If accessing /public/{orgDomain} on custom domain, redirect to root\n                        if (pathname === `/public/${orgDomain}`) {\n                            console.log(`[Custom Domain] Redirect /public/${orgDomain} → /`);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(new URL(\"/\", req.url));\n                        }\n                        // If accessing /public/{orgDomain}/{documentId}, redirect to /{documentId}\n                        const publicDocPattern = new RegExp(`^/public/${orgDomain.replace(\".\", \"\\\\.\")}/([a-f0-9]{24})$`, \"i\");\n                        const match = pathname.match(publicDocPattern);\n                        if (match) {\n                            const docId = match[1];\n                            console.log(`[Custom Domain] Redirect /public/${orgDomain}/${docId} → /${docId}`);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(new URL(`/${docId}`, req.url));\n                        }\n                        console.log(`[Custom Domain] Public route passthrough: ${pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Allow API calls for public data\n                    if (pathname.startsWith(\"/api/public\")) {\n                        console.log(`[Custom Domain] API passthrough: ${pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next({\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Block all other routes on custom domains (admin, dashboard, auth, etc.)\n                    // Users must access the main app domain (eaip.flyclim.com) for these features\n                    console.log(`Custom domain ${cleanDomain} blocked access to: ${pathname}`);\n                    return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                        error: \"Access Denied\",\n                        message: `This custom domain only provides public eAIP access. For administration, please visit the main application at ${process.env.NEXTAUTH_URL || \"https://eaip.flyclim.com\"}`,\n                        code: \"CUSTOM_DOMAIN_PUBLIC_ONLY\"\n                    }), {\n                        status: 403,\n                        headers: {\n                            \"content-type\": \"application/json\"\n                        }\n                    });\n                }\n            }\n            // Domain not found in our system\n            return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                error: \"Domain not configured\",\n                message: `The domain ${cleanDomain} is not associated with any organization.`,\n                code: \"DOMAIN_NOT_FOUND\"\n            }), {\n                status: 404,\n                headers: {\n                    \"content-type\": \"application/json\"\n                }\n            });\n        } catch (error) {\n            console.error(\"Domain lookup error:\", error);\n            return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                error: \"Domain lookup failed\",\n                message: \"Unable to resolve domain configuration.\",\n                code: \"DOMAIN_LOOKUP_ERROR\"\n            }), {\n                status: 500,\n                headers: {\n                    \"content-type\": \"application/json\"\n                }\n            });\n        }\n    }\n    // Main domain handling - no special tenant validation needed\n    return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next();\n}, {\n    callbacks: {\n        authorized: ({ token, req })=>{\n            const { pathname } = req.nextUrl;\n            // Define route categories\n            const publicRoutes = [\n                \"/public\",\n                \"/eaip\",\n                \"/api/public\",\n                \"/auth/signin\",\n                \"/auth/signup\",\n                \"/auth/error\",\n                \"/_next\",\n                \"/favicon.ico\"\n            ];\n            const protectedRoutes = [\n                \"/admin\",\n                \"/dashboard\",\n                \"/documents\",\n                \"/versions\",\n                \"/exports\",\n                \"/profile\",\n                \"/organization\",\n                \"/api/admin\",\n                \"/api/documents\",\n                \"/api/users\"\n            ];\n            // Allow public routes without authentication\n            if (publicRoutes.some((route)=>pathname.startsWith(route))) {\n                return true;\n            }\n            // Check if route requires authentication\n            const requiresAuth = protectedRoutes.some((route)=>pathname.startsWith(route));\n            if (requiresAuth) {\n                // Require valid token for protected routes\n                if (!token) {\n                    return false;\n                }\n                // Additional role-based checks\n                if (pathname.startsWith(\"/admin\") && token.role !== \"super_admin\") {\n                    return false;\n                }\n                return true;\n            }\n            // Default: allow access to unspecified routes\n            return true;\n        }\n    }\n}));\nconst config = {\n    matcher: [\n        /*\n     * Match all request paths except for the ones starting with:\n     * - api/auth (auth endpoints)\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - public folder\n     */ \"/((?!api/auth|_next/static|_next/image|favicon.ico|uploads|exports|auth).*)\"\n    ]\n};\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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VixPQUFPO2dCQUNUO2dCQUVBLCtCQUErQjtnQkFDL0IsSUFBSUYsU0FBUzZDLFVBQVUsQ0FBQyxhQUFhM0MsTUFBTXNFLElBQUksS0FBSyxlQUFlO29CQUNqRSxPQUFPO2dCQUNUO2dCQUVBLE9BQU87WUFDVDtZQUVBLDhDQUE4QztZQUM5QyxPQUFPO1FBQ1Q7SUFDRjtBQUNGLElBQ0E7QUFFSyxNQUFNQyxTQUFTO0lBQ3BCQyxTQUFTO1FBQ1A7Ozs7Ozs7S0FPQyxHQUNEO0tBQ0Q7QUFDSCxFQUFFIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vX05fRS8uL3NyYy9taWRkbGV3YXJlLnRzP2QxOTkiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgd2l0aEF1dGggfSBmcm9tIFwibmV4dC1hdXRoL21pZGRsZXdhcmVcIjtcbmltcG9ydCB7IE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xuaW1wb3J0IHsgRG9tYWluU2VydmljZSB9IGZyb20gXCJAL2xpYi9kb21haW5cIjtcblxuZXhwb3J0IGRlZmF1bHQgd2l0aEF1dGgoXG4gIGFzeW5jIGZ1bmN0aW9uIG1pZGRsZXdhcmUocmVxKSB7XG4gICAgY29uc3QgeyBwYXRobmFtZSB9ID0gcmVxLm5leHRVcmw7XG4gICAgY29uc3QgdG9rZW4gPSByZXEubmV4dGF1dGgudG9rZW47XG5cbiAgICAvLyBHZXQgaG9zdG5hbWUgZnJvbSBYLUZvcndhcmRlZC1Ib3N0IChOZ2lueCBwcm94eSkgb3IgZmFsbCBiYWNrIHRvIHJlcS5uZXh0VXJsLmhvc3RuYW1lXG4gICAgY29uc3QgZm9yd2FyZGVkSG9zdCA9XG4gICAgICByZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpIHx8IHJlcS5oZWFkZXJzLmdldChcImhvc3RcIikgfHwgXCJcIjtcbiAgICBjb25zdCBob3N0bmFtZSA9XG4gICAgICByZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpIHx8XG4gICAgICByZXEuaGVhZGVycy5nZXQoXCJob3N0XCIpIHx8XG4gICAgICBuZXcgVVJMKHJlcS51cmwpLmhvc3RuYW1lO1xuICAgIGNvbnN0IHByb3RvY29sID0gcmVxLmhlYWRlcnMuZ2V0KFwieC1mb3J3YXJkZWQtcHJvdG9cIikgfHwgXCJodHRwc1wiO1xuXG4gICAgY29uc3QgbmV4dFVybCA9IG5ldyBVUkwoXG4gICAgICByZXEubmV4dFVybC5wYXRobmFtZSxcbiAgICAgIGAke3Byb3RvY29sfTovLyR7Zm9yd2FyZGVkSG9zdH1gXG4gICAgKTtcblxuICAgIGNvbnNvbGUubG9nKGBbTWlkZGxld2FyZV0gUmVxdWVzdDogJHtob3N0bmFtZX0ke3JlcS5uZXh0VXJsLnBhdGhuYW1lfWAsIHtcbiAgICAgIFwieC1mb3J3YXJkZWQtaG9zdFwiOiByZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpLFxuICAgICAgaG9zdDogcmVxLmhlYWRlcnMuZ2V0KFwiaG9zdFwiKSxcbiAgICAgIFwibmV4dFVybC5ob3N0bmFtZVwiOiBuZXh0VXJsLmhvc3RuYW1lLFxuICAgIH0pO1xuXG4gICAgLy8gU2tpcCBwcm9jZXNzaW5nIGZvciBsb2NhbGhvc3QgYW5kIGRldmVsb3BtZW50XG4gICAgaWYgKFxuICAgICAgIXJlcS5oZWFkZXJzLmdldChcIngtbWlkZGxld2FyZS1yZXF1ZXN0XCIpICYmXG4gICAgICAoaG9zdG5hbWUgPT09IFwibG9jYWxob3N0XCIgfHwgZm9yd2FyZGVkSG9zdC5pbmNsdWRlcyhcImxvY2FsaG9zdFwiKSlcbiAgICApIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiW01pZGRsZXdhcmVdIFNraXBwaW5nIGV4dGVybmFsIGxvY2FsaG9zdFwiKTtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UubmV4dCgpO1xuICAgIH1cblxuICAgIC8vIFNpbXBsZSBkb21haW4gZXh0cmFjdGlvblxuICAgIGNvbnN0IGNsZWFuRG9tYWluID0gZm9yd2FyZGVkSG9zdC50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL153d3dcXC4vLCBcIlwiKTtcblxuICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBjdXN0b20gZG9tYWluIChub3Qgb3VyIG1haW4gYXBwbGljYXRpb24gZG9tYWlucylcbiAgICBjb25zdCBtYWluQXBwRG9tYWluID1cbiAgICAgIHByb2Nlc3MuZW52Lk5FWFRBVVRIX1VSTD8ucmVwbGFjZSgvXmh0dHBzPzpcXC9cXC8vLCBcIlwiKS5zcGxpdChcIi9cIilbMF0gfHxcbiAgICAgIFwiZWFpcC5mbHljbGltLmNvbVwiO1xuICAgIGNvbnN0IGlzTWFpbkRvbWFpbiA9XG4gICAgICBob3N0bmFtZSA9PT0gbWFpbkFwcERvbWFpbiB8fFxuICAgICAgaG9zdG5hbWUgPT09IFwiZWFpcC5mbHljbGltLmNvbVwiIHx8IC8vIEFsd2F5cyB0cmVhdCBlYWlwLmZseWNsaW0uY29tIGFzIG1haW4gZG9tYWluXG4gICAgICBob3N0bmFtZSA9PT0gXCJsb2NhbGhvc3RcIiB8fFxuICAgICAgaG9zdG5hbWUgPT09IFwiMC4wLjAuMFwiIHx8XG4gICAgICBob3N0bmFtZS5pbmNsdWRlcyhcImxvY2FsaG9zdFwiKSB8fFxuICAgICAgaG9zdG5hbWUuaW5jbHVkZXMoXCJ2ZXJjZWwuYXBwXCIpIHx8XG4gICAgICBob3N0bmFtZS5pbmNsdWRlcyhcIm5ldGxpZnkuYXBwXCIpO1xuXG4gICAgY29uc29sZS5sb2coYFtNaWRkbGV3YXJlXSBEb21haW4gY2hlY2s6YCwge1xuICAgICAgaG9zdG5hbWUsXG4gICAgICBjbGVhbkRvbWFpbixcbiAgICAgIG1haW5BcHBEb21haW4sXG4gICAgICBpc01haW5Eb21haW4sXG4gICAgfSk7XG5cbiAgICAvLyBIYW5kbGUgdGVuYW50LXNwZWNpZmljIGRvbWFpbiByb3V0aW5nXG4gICAgaWYgKCFpc01haW5Eb21haW4gJiYgY2xlYW5Eb21haW4gIT09IFwibG9jYWxob3N0XCIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEZvciBjdXN0b20gZG9tYWlucywgdXNlIGFuIEFQSSBjYWxsIHRvIGxvb2t1cCBvcmdhbml6YXRpb25cbiAgICAgICAgLy8gVXNlIGxvY2FsaG9zdCBmb3IgaW50ZXJuYWwgQVBJIGNhbGxzIHRvIGF2b2lkIFNTTCBpc3N1ZXNcbiAgICAgICAgY29uc3QgaW50ZXJuYWxPcmlnaW4gPSBcImh0dHA6Ly9sb2NhbGhvc3Q6MzAwMFwiO1xuICAgICAgICBjb25zdCBkb21haW5Mb29rdXBVcmwgPSBuZXcgVVJMKFxuICAgICAgICAgIFwiL2FwaS9vcmdhbml6YXRpb25zL2J5LWRvbWFpblwiLFxuICAgICAgICAgIGludGVybmFsT3JpZ2luXG4gICAgICAgICk7XG4gICAgICAgIGRvbWFpbkxvb2t1cFVybC5zZWFyY2hQYXJhbXMuc2V0KFwiZG9tYWluXCIsIGNsZWFuRG9tYWluKTtcblxuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBcIltNaWRkbGV3YXJlXSBGZXRjaGluZyBvcmcgZGF0YSBmcm9tOlwiLFxuICAgICAgICAgIGRvbWFpbkxvb2t1cFVybC50b1N0cmluZygpXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgZG9tYWluUmVzcG9uc2UgPSBhd2FpdCBmZXRjaChkb21haW5Mb29rdXBVcmwudG9TdHJpbmcoKSwge1xuICAgICAgICAgIGhlYWRlcnM6IHsgXCJ4LW1pZGRsZXdhcmUtcmVxdWVzdFwiOiBcInRydWVcIiB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoZG9tYWluUmVzcG9uc2Uub2spIHtcbiAgICAgICAgICBjb25zdCBkb21haW5EYXRhID0gYXdhaXQgZG9tYWluUmVzcG9uc2UuanNvbigpO1xuXG4gICAgICAgICAgaWYgKGRvbWFpbkRhdGEuc3VjY2VzcyAmJiBkb21haW5EYXRhLm9yZ2FuaXphdGlvbikge1xuICAgICAgICAgICAgLy8gU2V0IG9yZ2FuaXphdGlvbiBjb250ZXh0IGhlYWRlcnNcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3RIZWFkZXJzID0gbmV3IEhlYWRlcnMocmVxLmhlYWRlcnMpO1xuICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnMuc2V0KFwieC10ZW5hbnQtZG9tYWluXCIsIGNsZWFuRG9tYWluKTtcbiAgICAgICAgICAgIHJlcXVlc3RIZWFkZXJzLnNldChcIngtdGVuYW50LW9yZy1pZFwiLCBkb21haW5EYXRhLm9yZ2FuaXphdGlvbi5faWQpO1xuICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnMuc2V0KFxuICAgICAgICAgICAgICBcIngtdGVuYW50LW9yZy1uYW1lXCIsXG4gICAgICAgICAgICAgIGRvbWFpbkRhdGEub3JnYW5pemF0aW9uLm5hbWVcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIC8vIEZvciBhdXRoZW50aWNhdGVkIHVzZXJzLCB2YWxpZGF0ZSB0aGV5IGJlbG9uZyB0byB0aGlzIG9yZ2FuaXphdGlvblxuICAgICAgICAgICAgaWYgKHRva2VuKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHVzZXJPcmdJZCA9IHRva2VuLm9yZ2FuaXphdGlvbklkIGFzIHN0cmluZztcbiAgICAgICAgICAgICAgY29uc3QgZG9tYWluT3JnSWQgPSBkb21haW5EYXRhLm9yZ2FuaXphdGlvbi5faWQ7XG5cbiAgICAgICAgICAgICAgLy8gQmxvY2sgY3Jvc3MtdGVuYW50IGFjY2Vzc1xuICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgIURvbWFpblNlcnZpY2UudmFsaWRhdGVVc2VyQWNjZXNzKHVzZXJPcmdJZCwgZG9tYWluT3JnSWQpICYmXG4gICAgICAgICAgICAgICAgIXBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvYXV0aC9zaWduaW5cIilcbiAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgICBgQWNjZXNzIGRlbmllZDogVXNlciBvcmcgJHt1c2VyT3JnSWR9IGFjY2Vzc2luZyBkb21haW4gb3JnICR7ZG9tYWluT3JnSWR9YFxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAvLyBSZWRpcmVjdCB0byBkb21haW4tc3BlY2lmaWMgbG9naW5cbiAgICAgICAgICAgICAgICBjb25zdCBsb2dpblVybCA9IG5ldyBVUkwoXCIvYXV0aC9zaWduaW5cIiwgcmVxLnVybCk7XG4gICAgICAgICAgICAgICAgbG9naW5Vcmwuc2VhcmNoUGFyYW1zLnNldChcImVycm9yXCIsIFwidW5hdXRob3JpemVkXCIpO1xuICAgICAgICAgICAgICAgIGxvZ2luVXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJjYWxsYmFja1VybFwiLCBwYXRobmFtZSk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLnJlZGlyZWN0KGxvZ2luVXJsKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBDdXN0b20gZG9tYWlucyBPTkxZIHNlcnZlIHB1YmxpYyBwYWdlc1xuICAgICAgICAgICAgLy8gUmVkaXJlY3QgYWxsIGN1c3RvbSBkb21haW4gdHJhZmZpYyB0byBwdWJsaWMgZUFJUCBwYWdlc1xuICAgICAgICAgICAgY29uc3QgdXJsID0gcmVxLm5leHRVcmwuY2xvbmUoKTtcbiAgICAgICAgICAgIGNvbnN0IG9yZ0RvbWFpbiA9IGRvbWFpbkRhdGEub3JnYW5pemF0aW9uLmRvbWFpbjtcblxuICAgICAgICAgICAgLy8gTWFwIHJvb3QgdG8gcHVibGljIG9yZ2FuaXphdGlvbiBwYWdlXG4gICAgICAgICAgICBpZiAocGF0aG5hbWUgPT09IFwiL1wiKSB7XG4gICAgICAgICAgICAgIHVybC5wYXRobmFtZSA9IGAvcHVibGljLyR7b3JnRG9tYWlufWA7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgIGBbQ3VzdG9tIERvbWFpbl0gUm9vdCByZXdyaXRlOiAke2hvc3RuYW1lfS8g4oaSICR7dXJsLnBhdGhuYW1lfWBcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5yZXdyaXRlKHVybCwge1xuICAgICAgICAgICAgICAgIHJlcXVlc3Q6IHsgaGVhZGVyczogcmVxdWVzdEhlYWRlcnMgfSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIE1hcCBkb2N1bWVudCBJRHMgZGlyZWN0bHkgdG8gcHVibGljIGRvY3VtZW50IHBhZ2VzXG4gICAgICAgICAgICAvLyBQYXR0ZXJuOiAve2RvY3VtZW50SWR9IOKGkiAvcHVibGljL3tkb21haW59L3tkb2N1bWVudElkfVxuICAgICAgICAgICAgY29uc3QgZG9jdW1lbnRJZFBhdHRlcm4gPSAvXlxcLyhbYS1mMC05XXsyNH0pJC9pOyAvLyBNb25nb0RCIE9iamVjdElkIHBhdHRlcm5cbiAgICAgICAgICAgIGlmIChkb2N1bWVudElkUGF0dGVybi50ZXN0KHBhdGhuYW1lKSkge1xuICAgICAgICAgICAgICB1cmwucGF0aG5hbWUgPSBgL3B1YmxpYy8ke29yZ0RvbWFpbn0ke3BhdGhuYW1lfWA7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgIGBbQ3VzdG9tIERvbWFpbl0gRG9jdW1lbnQgcmV3cml0ZTogJHtob3N0bmFtZX0ke3BhdGhuYW1lfSDihpIgJHt1cmwucGF0aG5hbWV9YFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLnJld3JpdGUodXJsLCB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdDogeyBoZWFkZXJzOiByZXF1ZXN0SGVhZGVycyB9LFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gSGFuZGxlIC9wdWJsaWMgcm91dGVzIG9uIGN1c3RvbSBkb21haW5zXG4gICAgICAgICAgICBpZiAocGF0aG5hbWUuc3RhcnRzV2l0aChcIi9wdWJsaWNcIikpIHtcbiAgICAgICAgICAgICAgLy8gSWYgYWNjZXNzaW5nIC9wdWJsaWMve29yZ0RvbWFpbn0gb24gY3VzdG9tIGRvbWFpbiwgcmVkaXJlY3QgdG8gcm9vdFxuICAgICAgICAgICAgICBpZiAocGF0aG5hbWUgPT09IGAvcHVibGljLyR7b3JnRG9tYWlufWApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICAgIGBbQ3VzdG9tIERvbWFpbl0gUmVkaXJlY3QgL3B1YmxpYy8ke29yZ0RvbWFpbn0g4oaSIC9gXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLnJlZGlyZWN0KG5ldyBVUkwoXCIvXCIsIHJlcS51cmwpKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIC8vIElmIGFjY2Vzc2luZyAvcHVibGljL3tvcmdEb21haW59L3tkb2N1bWVudElkfSwgcmVkaXJlY3QgdG8gL3tkb2N1bWVudElkfVxuICAgICAgICAgICAgICBjb25zdCBwdWJsaWNEb2NQYXR0ZXJuID0gbmV3IFJlZ0V4cChcbiAgICAgICAgICAgICAgICBgXi9wdWJsaWMvJHtvcmdEb21haW4ucmVwbGFjZShcIi5cIiwgXCJcXFxcLlwiKX0vKFthLWYwLTldezI0fSkkYCxcbiAgICAgICAgICAgICAgICBcImlcIlxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IHBhdGhuYW1lLm1hdGNoKHB1YmxpY0RvY1BhdHRlcm4pO1xuICAgICAgICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBkb2NJZCA9IG1hdGNoWzFdO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgICAgYFtDdXN0b20gRG9tYWluXSBSZWRpcmVjdCAvcHVibGljLyR7b3JnRG9tYWlufS8ke2RvY0lkfSDihpIgLyR7ZG9jSWR9YFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5yZWRpcmVjdChuZXcgVVJMKGAvJHtkb2NJZH1gLCByZXEudXJsKSk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgW0N1c3RvbSBEb21haW5dIFB1YmxpYyByb3V0ZSBwYXNzdGhyb3VnaDogJHtwYXRobmFtZX1gXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmV3cml0ZSh1cmwsIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0OiB7IGhlYWRlcnM6IHJlcXVlc3RIZWFkZXJzIH0sXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBBbGxvdyBBUEkgY2FsbHMgZm9yIHB1YmxpYyBkYXRhXG4gICAgICAgICAgICBpZiAocGF0aG5hbWUuc3RhcnRzV2l0aChcIi9hcGkvcHVibGljXCIpKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbQ3VzdG9tIERvbWFpbl0gQVBJIHBhc3N0aHJvdWdoOiAke3BhdGhuYW1lfWApO1xuICAgICAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLm5leHQoe1xuICAgICAgICAgICAgICAgIHJlcXVlc3Q6IHsgaGVhZGVyczogcmVxdWVzdEhlYWRlcnMgfSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEJsb2NrIGFsbCBvdGhlciByb3V0ZXMgb24gY3VzdG9tIGRvbWFpbnMgKGFkbWluLCBkYXNoYm9hcmQsIGF1dGgsIGV0Yy4pXG4gICAgICAgICAgICAvLyBVc2VycyBtdXN0IGFjY2VzcyB0aGUgbWFpbiBhcHAgZG9tYWluIChlYWlwLmZseWNsaW0uY29tKSBmb3IgdGhlc2UgZmVhdHVyZXNcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICBgQ3VzdG9tIGRvbWFpbiAke2NsZWFuRG9tYWlufSBibG9ja2VkIGFjY2VzcyB0bzogJHtwYXRobmFtZX1gXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBOZXh0UmVzcG9uc2UoXG4gICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICBlcnJvcjogXCJBY2Nlc3MgRGVuaWVkXCIsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYFRoaXMgY3VzdG9tIGRvbWFpbiBvbmx5IHByb3ZpZGVzIHB1YmxpYyBlQUlQIGFjY2Vzcy4gRm9yIGFkbWluaXN0cmF0aW9uLCBwbGVhc2UgdmlzaXQgdGhlIG1haW4gYXBwbGljYXRpb24gYXQgJHtcbiAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52Lk5FWFRBVVRIX1VSTCB8fCBcImh0dHBzOi8vZWFpcC5mbHljbGltLmNvbVwiXG4gICAgICAgICAgICAgICAgfWAsXG4gICAgICAgICAgICAgICAgY29kZTogXCJDVVNUT01fRE9NQUlOX1BVQkxJQ19PTkxZXCIsXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiA0MDMsXG4gICAgICAgICAgICAgICAgaGVhZGVyczogeyBcImNvbnRlbnQtdHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERvbWFpbiBub3QgZm91bmQgaW4gb3VyIHN5c3RlbVxuICAgICAgICByZXR1cm4gbmV3IE5leHRSZXNwb25zZShcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBlcnJvcjogXCJEb21haW4gbm90IGNvbmZpZ3VyZWRcIixcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBUaGUgZG9tYWluICR7Y2xlYW5Eb21haW59IGlzIG5vdCBhc3NvY2lhdGVkIHdpdGggYW55IG9yZ2FuaXphdGlvbi5gLFxuICAgICAgICAgICAgY29kZTogXCJET01BSU5fTk9UX0ZPVU5EXCIsXG4gICAgICAgICAgfSksXG4gICAgICAgICAge1xuICAgICAgICAgICAgc3RhdHVzOiA0MDQsXG4gICAgICAgICAgICBoZWFkZXJzOiB7IFwiY29udGVudC10eXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiIH0sXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkRvbWFpbiBsb29rdXAgZXJyb3I6XCIsIGVycm9yKTtcbiAgICAgICAgcmV0dXJuIG5ldyBOZXh0UmVzcG9uc2UoXG4gICAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgZXJyb3I6IFwiRG9tYWluIGxvb2t1cCBmYWlsZWRcIixcbiAgICAgICAgICAgIG1lc3NhZ2U6IFwiVW5hYmxlIHRvIHJlc29sdmUgZG9tYWluIGNvbmZpZ3VyYXRpb24uXCIsXG4gICAgICAgICAgICBjb2RlOiBcIkRPTUFJTl9MT09LVVBfRVJST1JcIixcbiAgICAgICAgICB9KSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBzdGF0dXM6IDUwMCxcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgXCJjb250ZW50LXR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTWFpbiBkb21haW4gaGFuZGxpbmcgLSBubyBzcGVjaWFsIHRlbmFudCB2YWxpZGF0aW9uIG5lZWRlZFxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UubmV4dCgpO1xuICB9LFxuICB7XG4gICAgY2FsbGJhY2tzOiB7XG4gICAgICBhdXRob3JpemVkOiAoeyB0b2tlbiwgcmVxIH0pID0+IHtcbiAgICAgICAgY29uc3QgeyBwYXRobmFtZSB9ID0gcmVxLm5leHRVcmw7XG5cbiAgICAgICAgLy8gRGVmaW5lIHJvdXRlIGNhdGVnb3JpZXNcbiAgICAgICAgY29uc3QgcHVibGljUm91dGVzID0gW1xuICAgICAgICAgIFwiL3B1YmxpY1wiLFxuICAgICAgICAgIFwiL2VhaXBcIixcbiAgICAgICAgICBcIi9hcGkvcHVibGljXCIsXG4gICAgICAgICAgXCIvYXV0aC9zaWduaW5cIixcbiAgICAgICAgICBcIi9hdXRoL3NpZ251cFwiLFxuICAgICAgICAgIFwiL2F1dGgvZXJyb3JcIixcbiAgICAgICAgICBcIi9fbmV4dFwiLFxuICAgICAgICAgIFwiL2Zhdmljb24uaWNvXCIsXG4gICAgICAgIF07XG5cbiAgICAgICAgY29uc3QgcHJvdGVjdGVkUm91dGVzID0gW1xuICAgICAgICAgIFwiL2FkbWluXCIsXG4gICAgICAgICAgXCIvZGFzaGJvYXJkXCIsXG4gICAgICAgICAgXCIvZG9jdW1lbnRzXCIsXG4gICAgICAgICAgXCIvdmVyc2lvbnNcIixcbiAgICAgICAgICBcIi9leHBvcnRzXCIsXG4gICAgICAgICAgXCIvcHJvZmlsZVwiLFxuICAgICAgICAgIFwiL29yZ2FuaXphdGlvblwiLFxuICAgICAgICAgIFwiL2FwaS9hZG1pblwiLFxuICAgICAgICAgIFwiL2FwaS9kb2N1bWVudHNcIixcbiAgICAgICAgICBcIi9hcGkvdXNlcnNcIixcbiAgICAgICAgXTtcblxuICAgICAgICAvLyBBbGxvdyBwdWJsaWMgcm91dGVzIHdpdGhvdXQgYXV0aGVudGljYXRpb25cbiAgICAgICAgaWYgKHB1YmxpY1JvdXRlcy5zb21lKChyb3V0ZSkgPT4gcGF0aG5hbWUuc3RhcnRzV2l0aChyb3V0ZSkpKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBpZiByb3V0ZSByZXF1aXJlcyBhdXRoZW50aWNhdGlvblxuICAgICAgICBjb25zdCByZXF1aXJlc0F1dGggPSBwcm90ZWN0ZWRSb3V0ZXMuc29tZSgocm91dGUpID0+XG4gICAgICAgICAgcGF0aG5hbWUuc3RhcnRzV2l0aChyb3V0ZSlcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAocmVxdWlyZXNBdXRoKSB7XG4gICAgICAgICAgLy8gUmVxdWlyZSB2YWxpZCB0b2tlbiBmb3IgcHJvdGVjdGVkIHJvdXRlc1xuICAgICAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBBZGRpdGlvbmFsIHJvbGUtYmFzZWQgY2hlY2tzXG4gICAgICAgICAgaWYgKHBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvYWRtaW5cIikgJiYgdG9rZW4ucm9sZSAhPT0gXCJzdXBlcl9hZG1pblwiKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBEZWZhdWx0OiBhbGxvdyBhY2Nlc3MgdG8gdW5zcGVjaWZpZWQgcm91dGVzXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSxcbiAgICB9LFxuICB9XG4pO1xuXG5leHBvcnQgY29uc3QgY29uZmlnID0ge1xuICBtYXRjaGVyOiBbXG4gICAgLypcbiAgICAgKiBNYXRjaCBhbGwgcmVxdWVzdCBwYXRocyBleGNlcHQgZm9yIHRoZSBvbmVzIHN0YXJ0aW5nIHdpdGg6XG4gICAgICogLSBhcGkvYXV0aCAoYXV0aCBlbmRwb2ludHMpXG4gICAgICogLSBfbmV4dC9zdGF0aWMgKHN0YXRpYyBmaWxlcylcbiAgICAgKiAtIF9uZXh0L2ltYWdlIChpbWFnZSBvcHRpbWl6YXRpb24gZmlsZXMpXG4gICAgICogLSBmYXZpY29uLmljbyAoZmF2aWNvbiBmaWxlKVxuICAgICAqIC0gcHVibGljIGZvbGRlclxuICAgICAqL1xuICAgIFwiLygoPyFhcGkvYXV0aHxfbmV4dC9zdGF0aWN8X25leHQvaW1hZ2V8ZmF2aWNvbi5pY298dXBsb2Fkc3xleHBvcnRzfGF1dGgpLiopXCIsXG4gIF0sXG59O1xuIl0sIm5hbWVzIjpbIndpdGhBdXRoIiwiTmV4dFJlc3BvbnNlIiwiRG9tYWluU2VydmljZSIsIm1pZGRsZXdhcmUiLCJyZXEiLCJwYXRobmFtZSIsIm5leHRVcmwiLCJ0b2tlbiIsIm5leHRhdXRoIiwiZm9yd2FyZGVkSG9zdCIsImhlYWRlcnMiLCJnZXQiLCJob3N0bmFtZSIsIlVSTCIsInVybCIsInByb3RvY29sIiwiY29uc29sZSIsImxvZyIsImhvc3QiLCJpbmNsdWRlcyIsIm5leHQiLCJjbGVhbkRvbWFpbiIsInRvTG93ZXJDYXNlIiwicmVwbGFjZSIsIm1haW5BcHBEb21haW4iLCJwcm9jZXNzIiwiZW52IiwiTkVYVEFVVEhfVVJMIiwic3BsaXQiLCJpc01haW5Eb21haW4iLCJpbnRlcm5hbE9yaWdpbiIsImRvbWFpbkxvb2t1cFVybCIsInNlYXJjaFBhcmFtcyIsInNldCIsInRvU3RyaW5nIiwiZG9tYWluUmVzcG9uc2UiLCJmZXRjaCIsIm9rIiwiZG9tYWluRGF0YSIsImpzb24iLCJzdWNjZXNzIiwib3JnYW5pemF0aW9uIiwicmVxdWVzdEhlYWRlcnMiLCJIZWFkZXJzIiwiX2lkIiwibmFtZSIsInVzZXJPcmdJZCIsIm9yZ2FuaXphdGlvbklkIiwiZG9tYWluT3JnSWQiLCJ2YWxpZGF0ZVVzZXJBY2Nlc3MiLCJzdGFydHNXaXRoIiwibG9naW5VcmwiLCJyZWRpcmVjdCIsImNsb25lIiwib3JnRG9tYWluIiwiZG9tYWluIiwicmV3cml0ZSIsInJlcXVlc3QiLCJkb2N1bWVudElkUGF0dGVybiIsInRlc3QiLCJwdWJsaWNEb2NQYXR0ZXJuIiwiUmVnRXhwIiwibWF0Y2giLCJkb2NJZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnJvciIsIm1lc3NhZ2UiLCJjb2RlIiwic3RhdHVzIiwiY2FsbGJhY2tzIiwiYXV0aG9yaXplZCIsInB1YmxpY1JvdXRlcyIsInByb3RlY3RlZFJvdXRlcyIsInNvbWUiLCJyb3V0ZSIsInJlcXVpcmVzQXV0aCIsInJvbGUiLCJjb25maWciLCJtYXRjaGVyIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(middleware)/./src/middleware.ts\n");

/***/ })

});