"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("src/middleware",{

/***/ "(middleware)/./src/middleware.ts":
/*!***************************!*\
  !*** ./src/middleware.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__)\n/* harmony export */ });\n/* harmony import */ var next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next-auth/middleware */ \"(middleware)/./node_modules/next-auth/middleware.js\");\n/* harmony import */ var next_auth_middleware__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/server */ \"(middleware)/./node_modules/next/dist/esm/api/server.js\");\n/* harmony import */ var _lib_domain__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/domain */ \"(middleware)/./src/lib/domain.ts\");\n\n\n\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__.withAuth)(async function middleware(req) {\n    const { pathname } = req.nextUrl;\n    const token = req.nextauth.token;\n    // Get hostname from X-Forwarded-Host (Nginx proxy) or fall back to req.nextUrl.hostname\n    const forwardedHost = req.headers.get(\"x-forwarded-host\") || req.headers.get(\"host\") || \"\";\n    const hostname = req.headers.get(\"x-forwarded-host\") || req.headers.get(\"host\") || new URL(req.url).hostname;\n    console.log(`[Middleware] Request: ${hostname}${req.nextUrl.pathname}`, {\n        \"x-forwarded-host\": req.headers.get(\"x-forwarded-host\"),\n        host: req.headers.get(\"host\"),\n        \"nextUrl.hostname\": req.nextUrl.hostname\n    });\n    // Skip processing for localhost and development\n    if (!req.headers.get(\"x-middleware-request\") && (hostname === \"localhost\" || forwardedHost.includes(\"localhost\"))) {\n        console.log(\"[Middleware] Skipping external localhost\");\n        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next();\n    }\n    // Simple domain extraction\n    const cleanDomain = forwardedHost.toLowerCase().replace(/^www\\./, \"\");\n    // Check if this is a custom domain (not our main application domains)\n    const mainAppDomain = process.env.NEXTAUTH_URL?.replace(/^https?:\\/\\//, \"\").split(\"/\")[0] || \"eaip.flyclim.com\";\n    const isMainDomain = hostname === mainAppDomain || hostname === \"eaip.flyclim.com\" || // Always treat eaip.flyclim.com as main domain\n    hostname === \"localhost\" || hostname === \"0.0.0.0\" || hostname.includes(\"localhost\") || hostname.includes(\"vercel.app\") || hostname.includes(\"netlify.app\");\n    console.log(`[Middleware] Domain check:`, {\n        hostname,\n        cleanDomain,\n        mainAppDomain,\n        isMainDomain\n    });\n    // Handle tenant-specific domain routing\n    if (!isMainDomain && cleanDomain !== \"localhost\") {\n        try {\n            // For custom domains, use an API call to lookup organization\n            // Use localhost for internal API calls to avoid SSL issues\n            const internalOrigin = \"http://localhost:3000\";\n            const domainLookupUrl = new URL(\"/api/organizations/by-domain\", internalOrigin);\n            domainLookupUrl.searchParams.set(\"domain\", cleanDomain);\n            console.log(\"[Middleware] Fetching org data from:\", domainLookupUrl.toString());\n            const domainResponse = await fetch(domainLookupUrl.toString(), {\n                headers: {\n                    \"x-middleware-request\": \"true\"\n                }\n            });\n            if (domainResponse.ok) {\n                const domainData = await domainResponse.json();\n                if (domainData.success && domainData.organization) {\n                    // Set organization context headers\n                    const requestHeaders = new Headers(req.headers);\n                    requestHeaders.set(\"x-tenant-domain\", cleanDomain);\n                    requestHeaders.set(\"x-tenant-org-id\", domainData.organization._id);\n                    requestHeaders.set(\"x-tenant-org-name\", domainData.organization.name);\n                    // For authenticated users, validate they belong to this organization\n                    if (token) {\n                        const userOrgId = token.organizationId;\n                        const domainOrgId = domainData.organization._id;\n                        // Block cross-tenant access\n                        if (!_lib_domain__WEBPACK_IMPORTED_MODULE_2__.DomainService.validateUserAccess(userOrgId, domainOrgId) && !pathname.startsWith(\"/auth/signin\")) {\n                            console.log(`Access denied: User org ${userOrgId} accessing domain org ${domainOrgId}`);\n                            // Redirect to domain-specific login\n                            const loginUrl = new URL(\"/auth/signin\", req.url);\n                            loginUrl.searchParams.set(\"error\", \"unauthorized\");\n                            loginUrl.searchParams.set(\"callbackUrl\", pathname);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(loginUrl);\n                        }\n                    }\n                    // Custom domains ONLY serve public pages\n                    // Redirect all custom domain traffic to public eAIP pages\n                    const url = req.nextUrl.clone();\n                    const orgDomain = domainData.organization.domain;\n                    // Map root to public organization page\n                    if (pathname === \"/\") {\n                        url.pathname = `/public/${orgDomain}`;\n                        console.log(`[Custom Domain] Root rewrite: ${hostname}/ → ${url.pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Map document IDs directly to public document pages\n                    // Pattern: /{documentId} → /public/{domain}/{documentId}\n                    const documentIdPattern = /^\\/([a-f0-9]{24})$/i; // MongoDB ObjectId pattern\n                    if (documentIdPattern.test(pathname)) {\n                        url.pathname = `/public/${orgDomain}${pathname}`;\n                        console.log(`[Custom Domain] Document rewrite: ${hostname}${pathname} → ${url.pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Handle /public routes on custom domains\n                    if (pathname.startsWith(\"/public\")) {\n                        // If accessing /public/{orgDomain} on custom domain, redirect to root\n                        if (pathname === `/public/${orgDomain}`) {\n                            console.log(`[Custom Domain] Redirect /public/${orgDomain} → /`);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(new URL(\"/\", req.url));\n                        }\n                        // If accessing /public/{orgDomain}/{documentId}, redirect to /{documentId}\n                        const publicDocPattern = new RegExp(`^/public/${orgDomain.replace(\".\", \"\\\\.\")}/([a-f0-9]{24})$`, \"i\");\n                        const match = pathname.match(publicDocPattern);\n                        if (match) {\n                            const docId = match[1];\n                            console.log(`[Custom Domain] Redirect /public/${orgDomain}/${docId} → /${docId}`);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(new URL(`/${docId}`, req.url));\n                        }\n                        console.log(`[Custom Domain] Public route passthrough: ${pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Allow API calls for public data\n                    if (pathname.startsWith(\"/api/public\")) {\n                        console.log(`[Custom Domain] API passthrough: ${pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next({\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Block all other routes on custom domains (admin, dashboard, auth, etc.)\n                    // Users must access the main app domain (eaip.flyclim.com) for these features\n                    console.log(`Custom domain ${cleanDomain} blocked access to: ${pathname}`);\n                    return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                        error: \"Access Denied\",\n                        message: `This custom domain only provides public eAIP access. For administration, please visit the main application at ${process.env.NEXTAUTH_URL || \"https://eaip.flyclim.com\"}`,\n                        code: \"CUSTOM_DOMAIN_PUBLIC_ONLY\"\n                    }), {\n                        status: 403,\n                        headers: {\n                            \"content-type\": \"application/json\"\n                        }\n                    });\n                }\n            }\n            // Domain not found in our system\n            return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                error: \"Domain not configured\",\n                message: `The domain ${cleanDomain} is not associated with any organization.`,\n                code: \"DOMAIN_NOT_FOUND\"\n            }), {\n                status: 404,\n                headers: {\n                    \"content-type\": \"application/json\"\n                }\n            });\n        } catch (error) {\n            console.error(\"Domain lookup error:\", error);\n            return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                error: \"Domain lookup failed\",\n                message: \"Unable to resolve domain configuration.\",\n                code: \"DOMAIN_LOOKUP_ERROR\"\n            }), {\n                status: 500,\n                headers: {\n                    \"content-type\": \"application/json\"\n                }\n            });\n        }\n    }\n    // Main domain handling - no special tenant validation needed\n    return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next();\n}, {\n    callbacks: {\n        authorized: ({ token, req })=>{\n            const { pathname } = req.nextUrl;\n            // Define route categories\n            const publicRoutes = [\n                \"/public\",\n                \"/eaip\",\n                \"/api/public\",\n                \"/auth/signin\",\n                \"/auth/signup\",\n                \"/auth/error\",\n                \"/_next\",\n                \"/favicon.ico\"\n            ];\n            const protectedRoutes = [\n                \"/admin\",\n                \"/dashboard\",\n                \"/documents\",\n                \"/versions\",\n                \"/exports\",\n                \"/profile\",\n                \"/organization\",\n                \"/api/admin\",\n                \"/api/documents\",\n                \"/api/users\"\n            ];\n            // Allow public routes without authentication\n            if (publicRoutes.some((route)=>pathname.startsWith(route))) {\n                return true;\n            }\n            // Check if route requires authentication\n            const requiresAuth = protectedRoutes.some((route)=>pathname.startsWith(route));\n            if (requiresAuth) {\n                // Require valid token for protected routes\n                if (!token) {\n                    return false;\n                }\n                // Additional role-based checks\n                if (pathname.startsWith(\"/admin\") && token.role !== \"super_admin\") {\n                    return false;\n                }\n                return true;\n            }\n            // Default: allow access to unspecified routes\n            return true;\n        }\n    }\n}));\nconst config = {\n    matcher: [\n        /*\n     * Match all request paths except for the ones starting with:\n     * - api/auth (auth endpoints)\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - public folder\n     */ \"/((?!api/auth|_next/static|_next/image|favicon.ico|uploads|exports|auth).*)\"\n    ]\n};\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFPO1FBQ1Q7SUFDRjtBQUNGLElBQ0E7QUFFSyxNQUFNQyxTQUFTO0lBQ3BCQyxTQUFTO1FBQ1A7Ozs7Ozs7S0FPQyxHQUNEO0tBQ0Q7QUFDSCxFQUFFIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vX05fRS8uL3NyYy9taWRkbGV3YXJlLnRzP2QxOTkiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgd2l0aEF1dGggfSBmcm9tIFwibmV4dC1hdXRoL21pZGRsZXdhcmVcIjtcbmltcG9ydCB7IE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xuaW1wb3J0IHsgRG9tYWluU2VydmljZSB9IGZyb20gXCJAL2xpYi9kb21haW5cIjtcblxuZXhwb3J0IGRlZmF1bHQgd2l0aEF1dGgoXG4gIGFzeW5jIGZ1bmN0aW9uIG1pZGRsZXdhcmUocmVxKSB7XG4gICAgY29uc3QgeyBwYXRobmFtZSB9ID0gcmVxLm5leHRVcmw7XG4gICAgY29uc3QgdG9rZW4gPSByZXEubmV4dGF1dGgudG9rZW47XG5cbiAgICAvLyBHZXQgaG9zdG5hbWUgZnJvbSBYLUZvcndhcmRlZC1Ib3N0IChOZ2lueCBwcm94eSkgb3IgZmFsbCBiYWNrIHRvIHJlcS5uZXh0VXJsLmhvc3RuYW1lXG4gICAgY29uc3QgZm9yd2FyZGVkSG9zdCA9XG4gICAgICByZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpIHx8IHJlcS5oZWFkZXJzLmdldChcImhvc3RcIikgfHwgXCJcIjtcbiAgICBjb25zdCBob3N0bmFtZSA9XG4gICAgICByZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpIHx8XG4gICAgICByZXEuaGVhZGVycy5nZXQoXCJob3N0XCIpIHx8XG4gICAgICBuZXcgVVJMKHJlcS51cmwpLmhvc3RuYW1lO1xuICAgIGNvbnNvbGUubG9nKGBbTWlkZGxld2FyZV0gUmVxdWVzdDogJHtob3N0bmFtZX0ke3JlcS5uZXh0VXJsLnBhdGhuYW1lfWAsIHtcbiAgICAgIFwieC1mb3J3YXJkZWQtaG9zdFwiOiByZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpLFxuICAgICAgaG9zdDogcmVxLmhlYWRlcnMuZ2V0KFwiaG9zdFwiKSxcbiAgICAgIFwibmV4dFVybC5ob3N0bmFtZVwiOiByZXEubmV4dFVybC5ob3N0bmFtZSxcbiAgICB9KTtcblxuICAgIC8vIFNraXAgcHJvY2Vzc2luZyBmb3IgbG9jYWxob3N0IGFuZCBkZXZlbG9wbWVudFxuICAgIGlmIChcbiAgICAgICFyZXEuaGVhZGVycy5nZXQoXCJ4LW1pZGRsZXdhcmUtcmVxdWVzdFwiKSAmJlxuICAgICAgKGhvc3RuYW1lID09PSBcImxvY2FsaG9zdFwiIHx8IGZvcndhcmRlZEhvc3QuaW5jbHVkZXMoXCJsb2NhbGhvc3RcIikpXG4gICAgKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIltNaWRkbGV3YXJlXSBTa2lwcGluZyBleHRlcm5hbCBsb2NhbGhvc3RcIik7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLm5leHQoKTtcbiAgICB9XG5cbiAgICAvLyBTaW1wbGUgZG9tYWluIGV4dHJhY3Rpb25cbiAgICBjb25zdCBjbGVhbkRvbWFpbiA9IGZvcndhcmRlZEhvc3QudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9ed3d3XFwuLywgXCJcIik7XG5cbiAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgY3VzdG9tIGRvbWFpbiAobm90IG91ciBtYWluIGFwcGxpY2F0aW9uIGRvbWFpbnMpXG4gICAgY29uc3QgbWFpbkFwcERvbWFpbiA9XG4gICAgICBwcm9jZXNzLmVudi5ORVhUQVVUSF9VUkw/LnJlcGxhY2UoL15odHRwcz86XFwvXFwvLywgXCJcIikuc3BsaXQoXCIvXCIpWzBdIHx8XG4gICAgICBcImVhaXAuZmx5Y2xpbS5jb21cIjtcbiAgICBjb25zdCBpc01haW5Eb21haW4gPVxuICAgICAgaG9zdG5hbWUgPT09IG1haW5BcHBEb21haW4gfHxcbiAgICAgIGhvc3RuYW1lID09PSBcImVhaXAuZmx5Y2xpbS5jb21cIiB8fCAvLyBBbHdheXMgdHJlYXQgZWFpcC5mbHljbGltLmNvbSBhcyBtYWluIGRvbWFpblxuICAgICAgaG9zdG5hbWUgPT09IFwibG9jYWxob3N0XCIgfHxcbiAgICAgIGhvc3RuYW1lID09PSBcIjAuMC4wLjBcIiB8fFxuICAgICAgaG9zdG5hbWUuaW5jbHVkZXMoXCJsb2NhbGhvc3RcIikgfHxcbiAgICAgIGhvc3RuYW1lLmluY2x1ZGVzKFwidmVyY2VsLmFwcFwiKSB8fFxuICAgICAgaG9zdG5hbWUuaW5jbHVkZXMoXCJuZXRsaWZ5LmFwcFwiKTtcblxuICAgIGNvbnNvbGUubG9nKGBbTWlkZGxld2FyZV0gRG9tYWluIGNoZWNrOmAsIHtcbiAgICAgIGhvc3RuYW1lLFxuICAgICAgY2xlYW5Eb21haW4sXG4gICAgICBtYWluQXBwRG9tYWluLFxuICAgICAgaXNNYWluRG9tYWluLFxuICAgIH0pO1xuXG4gICAgLy8gSGFuZGxlIHRlbmFudC1zcGVjaWZpYyBkb21haW4gcm91dGluZ1xuICAgIGlmICghaXNNYWluRG9tYWluICYmIGNsZWFuRG9tYWluICE9PSBcImxvY2FsaG9zdFwiKSB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBGb3IgY3VzdG9tIGRvbWFpbnMsIHVzZSBhbiBBUEkgY2FsbCB0byBsb29rdXAgb3JnYW5pemF0aW9uXG4gICAgICAgIC8vIFVzZSBsb2NhbGhvc3QgZm9yIGludGVybmFsIEFQSSBjYWxscyB0byBhdm9pZCBTU0wgaXNzdWVzXG4gICAgICAgIGNvbnN0IGludGVybmFsT3JpZ2luID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDBcIjtcbiAgICAgICAgY29uc3QgZG9tYWluTG9va3VwVXJsID0gbmV3IFVSTChcbiAgICAgICAgICBcIi9hcGkvb3JnYW5pemF0aW9ucy9ieS1kb21haW5cIixcbiAgICAgICAgICBpbnRlcm5hbE9yaWdpblxuICAgICAgICApO1xuICAgICAgICBkb21haW5Mb29rdXBVcmwuc2VhcmNoUGFyYW1zLnNldChcImRvbWFpblwiLCBjbGVhbkRvbWFpbik7XG5cbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgXCJbTWlkZGxld2FyZV0gRmV0Y2hpbmcgb3JnIGRhdGEgZnJvbTpcIixcbiAgICAgICAgICBkb21haW5Mb29rdXBVcmwudG9TdHJpbmcoKVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGRvbWFpblJlc3BvbnNlID0gYXdhaXQgZmV0Y2goZG9tYWluTG9va3VwVXJsLnRvU3RyaW5nKCksIHtcbiAgICAgICAgICBoZWFkZXJzOiB7IFwieC1taWRkbGV3YXJlLXJlcXVlc3RcIjogXCJ0cnVlXCIgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGRvbWFpblJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgY29uc3QgZG9tYWluRGF0YSA9IGF3YWl0IGRvbWFpblJlc3BvbnNlLmpzb24oKTtcblxuICAgICAgICAgIGlmIChkb21haW5EYXRhLnN1Y2Nlc3MgJiYgZG9tYWluRGF0YS5vcmdhbml6YXRpb24pIHtcbiAgICAgICAgICAgIC8vIFNldCBvcmdhbml6YXRpb24gY29udGV4dCBoZWFkZXJzXG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0SGVhZGVycyA9IG5ldyBIZWFkZXJzKHJlcS5oZWFkZXJzKTtcbiAgICAgICAgICAgIHJlcXVlc3RIZWFkZXJzLnNldChcIngtdGVuYW50LWRvbWFpblwiLCBjbGVhbkRvbWFpbik7XG4gICAgICAgICAgICByZXF1ZXN0SGVhZGVycy5zZXQoXCJ4LXRlbmFudC1vcmctaWRcIiwgZG9tYWluRGF0YS5vcmdhbml6YXRpb24uX2lkKTtcbiAgICAgICAgICAgIHJlcXVlc3RIZWFkZXJzLnNldChcbiAgICAgICAgICAgICAgXCJ4LXRlbmFudC1vcmctbmFtZVwiLFxuICAgICAgICAgICAgICBkb21haW5EYXRhLm9yZ2FuaXphdGlvbi5uYW1lXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvLyBGb3IgYXV0aGVudGljYXRlZCB1c2VycywgdmFsaWRhdGUgdGhleSBiZWxvbmcgdG8gdGhpcyBvcmdhbml6YXRpb25cbiAgICAgICAgICAgIGlmICh0b2tlbikge1xuICAgICAgICAgICAgICBjb25zdCB1c2VyT3JnSWQgPSB0b2tlbi5vcmdhbml6YXRpb25JZCBhcyBzdHJpbmc7XG4gICAgICAgICAgICAgIGNvbnN0IGRvbWFpbk9yZ0lkID0gZG9tYWluRGF0YS5vcmdhbml6YXRpb24uX2lkO1xuXG4gICAgICAgICAgICAgIC8vIEJsb2NrIGNyb3NzLXRlbmFudCBhY2Nlc3NcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICFEb21haW5TZXJ2aWNlLnZhbGlkYXRlVXNlckFjY2Vzcyh1c2VyT3JnSWQsIGRvbWFpbk9yZ0lkKSAmJlxuICAgICAgICAgICAgICAgICFwYXRobmFtZS5zdGFydHNXaXRoKFwiL2F1dGgvc2lnbmluXCIpXG4gICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgICAgYEFjY2VzcyBkZW5pZWQ6IFVzZXIgb3JnICR7dXNlck9yZ0lkfSBhY2Nlc3NpbmcgZG9tYWluIG9yZyAke2RvbWFpbk9yZ0lkfWBcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgLy8gUmVkaXJlY3QgdG8gZG9tYWluLXNwZWNpZmljIGxvZ2luXG4gICAgICAgICAgICAgICAgY29uc3QgbG9naW5VcmwgPSBuZXcgVVJMKFwiL2F1dGgvc2lnbmluXCIsIHJlcS51cmwpO1xuICAgICAgICAgICAgICAgIGxvZ2luVXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJlcnJvclwiLCBcInVuYXV0aG9yaXplZFwiKTtcbiAgICAgICAgICAgICAgICBsb2dpblVybC5zZWFyY2hQYXJhbXMuc2V0KFwiY2FsbGJhY2tVcmxcIiwgcGF0aG5hbWUpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5yZWRpcmVjdChsb2dpblVybCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gQ3VzdG9tIGRvbWFpbnMgT05MWSBzZXJ2ZSBwdWJsaWMgcGFnZXNcbiAgICAgICAgICAgIC8vIFJlZGlyZWN0IGFsbCBjdXN0b20gZG9tYWluIHRyYWZmaWMgdG8gcHVibGljIGVBSVAgcGFnZXNcbiAgICAgICAgICAgIGNvbnN0IHVybCA9IHJlcS5uZXh0VXJsLmNsb25lKCk7XG4gICAgICAgICAgICBjb25zdCBvcmdEb21haW4gPSBkb21haW5EYXRhLm9yZ2FuaXphdGlvbi5kb21haW47XG5cbiAgICAgICAgICAgIC8vIE1hcCByb290IHRvIHB1YmxpYyBvcmdhbml6YXRpb24gcGFnZVxuICAgICAgICAgICAgaWYgKHBhdGhuYW1lID09PSBcIi9cIikge1xuICAgICAgICAgICAgICB1cmwucGF0aG5hbWUgPSBgL3B1YmxpYy8ke29yZ0RvbWFpbn1gO1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgW0N1c3RvbSBEb21haW5dIFJvb3QgcmV3cml0ZTogJHtob3N0bmFtZX0vIOKGkiAke3VybC5wYXRobmFtZX1gXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmV3cml0ZSh1cmwsIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0OiB7IGhlYWRlcnM6IHJlcXVlc3RIZWFkZXJzIH0sXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBNYXAgZG9jdW1lbnQgSURzIGRpcmVjdGx5IHRvIHB1YmxpYyBkb2N1bWVudCBwYWdlc1xuICAgICAgICAgICAgLy8gUGF0dGVybjogL3tkb2N1bWVudElkfSDihpIgL3B1YmxpYy97ZG9tYWlufS97ZG9jdW1lbnRJZH1cbiAgICAgICAgICAgIGNvbnN0IGRvY3VtZW50SWRQYXR0ZXJuID0gL15cXC8oW2EtZjAtOV17MjR9KSQvaTsgLy8gTW9uZ29EQiBPYmplY3RJZCBwYXR0ZXJuXG4gICAgICAgICAgICBpZiAoZG9jdW1lbnRJZFBhdHRlcm4udGVzdChwYXRobmFtZSkpIHtcbiAgICAgICAgICAgICAgdXJsLnBhdGhuYW1lID0gYC9wdWJsaWMvJHtvcmdEb21haW59JHtwYXRobmFtZX1gO1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICBgW0N1c3RvbSBEb21haW5dIERvY3VtZW50IHJld3JpdGU6ICR7aG9zdG5hbWV9JHtwYXRobmFtZX0g4oaSICR7dXJsLnBhdGhuYW1lfWBcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5yZXdyaXRlKHVybCwge1xuICAgICAgICAgICAgICAgIHJlcXVlc3Q6IHsgaGVhZGVyczogcmVxdWVzdEhlYWRlcnMgfSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEhhbmRsZSAvcHVibGljIHJvdXRlcyBvbiBjdXN0b20gZG9tYWluc1xuICAgICAgICAgICAgaWYgKHBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvcHVibGljXCIpKSB7XG4gICAgICAgICAgICAgIC8vIElmIGFjY2Vzc2luZyAvcHVibGljL3tvcmdEb21haW59IG9uIGN1c3RvbSBkb21haW4sIHJlZGlyZWN0IHRvIHJvb3RcbiAgICAgICAgICAgICAgaWYgKHBhdGhuYW1lID09PSBgL3B1YmxpYy8ke29yZ0RvbWFpbn1gKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgICBgW0N1c3RvbSBEb21haW5dIFJlZGlyZWN0IC9wdWJsaWMvJHtvcmdEb21haW59IOKGkiAvYFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5yZWRpcmVjdChuZXcgVVJMKFwiL1wiLCByZXEudXJsKSk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAvLyBJZiBhY2Nlc3NpbmcgL3B1YmxpYy97b3JnRG9tYWlufS97ZG9jdW1lbnRJZH0sIHJlZGlyZWN0IHRvIC97ZG9jdW1lbnRJZH1cbiAgICAgICAgICAgICAgY29uc3QgcHVibGljRG9jUGF0dGVybiA9IG5ldyBSZWdFeHAoXG4gICAgICAgICAgICAgICAgYF4vcHVibGljLyR7b3JnRG9tYWluLnJlcGxhY2UoXCIuXCIsIFwiXFxcXC5cIil9LyhbYS1mMC05XXsyNH0pJGAsXG4gICAgICAgICAgICAgICAgXCJpXCJcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBwYXRobmFtZS5tYXRjaChwdWJsaWNEb2NQYXR0ZXJuKTtcbiAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZG9jSWQgPSBtYXRjaFsxXTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICAgIGBbQ3VzdG9tIERvbWFpbl0gUmVkaXJlY3QgL3B1YmxpYy8ke29yZ0RvbWFpbn0vJHtkb2NJZH0g4oaSIC8ke2RvY0lkfWBcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmVkaXJlY3QobmV3IFVSTChgLyR7ZG9jSWR9YCwgcmVxLnVybCkpO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgYFtDdXN0b20gRG9tYWluXSBQdWJsaWMgcm91dGUgcGFzc3Rocm91Z2g6ICR7cGF0aG5hbWV9YFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLnJld3JpdGUodXJsLCB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdDogeyBoZWFkZXJzOiByZXF1ZXN0SGVhZGVycyB9LFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gQWxsb3cgQVBJIGNhbGxzIGZvciBwdWJsaWMgZGF0YVxuICAgICAgICAgICAgaWYgKHBhdGhuYW1lLnN0YXJ0c1dpdGgoXCIvYXBpL3B1YmxpY1wiKSkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW0N1c3RvbSBEb21haW5dIEFQSSBwYXNzdGhyb3VnaDogJHtwYXRobmFtZX1gKTtcbiAgICAgICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5uZXh0KHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0OiB7IGhlYWRlcnM6IHJlcXVlc3RIZWFkZXJzIH0sXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBCbG9jayBhbGwgb3RoZXIgcm91dGVzIG9uIGN1c3RvbSBkb21haW5zIChhZG1pbiwgZGFzaGJvYXJkLCBhdXRoLCBldGMuKVxuICAgICAgICAgICAgLy8gVXNlcnMgbXVzdCBhY2Nlc3MgdGhlIG1haW4gYXBwIGRvbWFpbiAoZWFpcC5mbHljbGltLmNvbSkgZm9yIHRoZXNlIGZlYXR1cmVzXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgYEN1c3RvbSBkb21haW4gJHtjbGVhbkRvbWFpbn0gYmxvY2tlZCBhY2Nlc3MgdG86ICR7cGF0aG5hbWV9YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiBuZXcgTmV4dFJlc3BvbnNlKFxuICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgZXJyb3I6IFwiQWNjZXNzIERlbmllZFwiLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBUaGlzIGN1c3RvbSBkb21haW4gb25seSBwcm92aWRlcyBwdWJsaWMgZUFJUCBhY2Nlc3MuIEZvciBhZG1pbmlzdHJhdGlvbiwgcGxlYXNlIHZpc2l0IHRoZSBtYWluIGFwcGxpY2F0aW9uIGF0ICR7XG4gICAgICAgICAgICAgICAgICBwcm9jZXNzLmVudi5ORVhUQVVUSF9VUkwgfHwgXCJodHRwczovL2VhaXAuZmx5Y2xpbS5jb21cIlxuICAgICAgICAgICAgICAgIH1gLFxuICAgICAgICAgICAgICAgIGNvZGU6IFwiQ1VTVE9NX0RPTUFJTl9QVUJMSUNfT05MWVwiLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHN0YXR1czogNDAzLFxuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsgXCJjb250ZW50LXR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBEb21haW4gbm90IGZvdW5kIGluIG91ciBzeXN0ZW1cbiAgICAgICAgcmV0dXJuIG5ldyBOZXh0UmVzcG9uc2UoXG4gICAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgZXJyb3I6IFwiRG9tYWluIG5vdCBjb25maWd1cmVkXCIsXG4gICAgICAgICAgICBtZXNzYWdlOiBgVGhlIGRvbWFpbiAke2NsZWFuRG9tYWlufSBpcyBub3QgYXNzb2NpYXRlZCB3aXRoIGFueSBvcmdhbml6YXRpb24uYCxcbiAgICAgICAgICAgIGNvZGU6IFwiRE9NQUlOX05PVF9GT1VORFwiLFxuICAgICAgICAgIH0pLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHN0YXR1czogNDA0LFxuICAgICAgICAgICAgaGVhZGVyczogeyBcImNvbnRlbnQtdHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJEb21haW4gbG9va3VwIGVycm9yOlwiLCBlcnJvcik7XG4gICAgICAgIHJldHVybiBuZXcgTmV4dFJlc3BvbnNlKFxuICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIGVycm9yOiBcIkRvbWFpbiBsb29rdXAgZmFpbGVkXCIsXG4gICAgICAgICAgICBtZXNzYWdlOiBcIlVuYWJsZSB0byByZXNvbHZlIGRvbWFpbiBjb25maWd1cmF0aW9uLlwiLFxuICAgICAgICAgICAgY29kZTogXCJET01BSU5fTE9PS1VQX0VSUk9SXCIsXG4gICAgICAgICAgfSksXG4gICAgICAgICAge1xuICAgICAgICAgICAgc3RhdHVzOiA1MDAsXG4gICAgICAgICAgICBoZWFkZXJzOiB7IFwiY29udGVudC10eXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiIH0sXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE1haW4gZG9tYWluIGhhbmRsaW5nIC0gbm8gc3BlY2lhbCB0ZW5hbnQgdmFsaWRhdGlvbiBuZWVkZWRcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLm5leHQoKTtcbiAgfSxcbiAge1xuICAgIGNhbGxiYWNrczoge1xuICAgICAgYXV0aG9yaXplZDogKHsgdG9rZW4sIHJlcSB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgcGF0aG5hbWUgfSA9IHJlcS5uZXh0VXJsO1xuXG4gICAgICAgIC8vIERlZmluZSByb3V0ZSBjYXRlZ29yaWVzXG4gICAgICAgIGNvbnN0IHB1YmxpY1JvdXRlcyA9IFtcbiAgICAgICAgICBcIi9wdWJsaWNcIixcbiAgICAgICAgICBcIi9lYWlwXCIsXG4gICAgICAgICAgXCIvYXBpL3B1YmxpY1wiLFxuICAgICAgICAgIFwiL2F1dGgvc2lnbmluXCIsXG4gICAgICAgICAgXCIvYXV0aC9zaWdudXBcIixcbiAgICAgICAgICBcIi9hdXRoL2Vycm9yXCIsXG4gICAgICAgICAgXCIvX25leHRcIixcbiAgICAgICAgICBcIi9mYXZpY29uLmljb1wiLFxuICAgICAgICBdO1xuXG4gICAgICAgIGNvbnN0IHByb3RlY3RlZFJvdXRlcyA9IFtcbiAgICAgICAgICBcIi9hZG1pblwiLFxuICAgICAgICAgIFwiL2Rhc2hib2FyZFwiLFxuICAgICAgICAgIFwiL2RvY3VtZW50c1wiLFxuICAgICAgICAgIFwiL3ZlcnNpb25zXCIsXG4gICAgICAgICAgXCIvZXhwb3J0c1wiLFxuICAgICAgICAgIFwiL3Byb2ZpbGVcIixcbiAgICAgICAgICBcIi9vcmdhbml6YXRpb25cIixcbiAgICAgICAgICBcIi9hcGkvYWRtaW5cIixcbiAgICAgICAgICBcIi9hcGkvZG9jdW1lbnRzXCIsXG4gICAgICAgICAgXCIvYXBpL3VzZXJzXCIsXG4gICAgICAgIF07XG5cbiAgICAgICAgLy8gQWxsb3cgcHVibGljIHJvdXRlcyB3aXRob3V0IGF1dGhlbnRpY2F0aW9uXG4gICAgICAgIGlmIChwdWJsaWNSb3V0ZXMuc29tZSgocm91dGUpID0+IHBhdGhuYW1lLnN0YXJ0c1dpdGgocm91dGUpKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgcm91dGUgcmVxdWlyZXMgYXV0aGVudGljYXRpb25cbiAgICAgICAgY29uc3QgcmVxdWlyZXNBdXRoID0gcHJvdGVjdGVkUm91dGVzLnNvbWUoKHJvdXRlKSA9PlxuICAgICAgICAgIHBhdGhuYW1lLnN0YXJ0c1dpdGgocm91dGUpXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHJlcXVpcmVzQXV0aCkge1xuICAgICAgICAgIC8vIFJlcXVpcmUgdmFsaWQgdG9rZW4gZm9yIHByb3RlY3RlZCByb3V0ZXNcbiAgICAgICAgICBpZiAoIXRva2VuKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gQWRkaXRpb25hbCByb2xlLWJhc2VkIGNoZWNrc1xuICAgICAgICAgIGlmIChwYXRobmFtZS5zdGFydHNXaXRoKFwiL2FkbWluXCIpICYmIHRva2VuLnJvbGUgIT09IFwic3VwZXJfYWRtaW5cIikge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRGVmYXVsdDogYWxsb3cgYWNjZXNzIHRvIHVuc3BlY2lmaWVkIHJvdXRlc1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0sXG4gICAgfSxcbiAgfVxuKTtcblxuZXhwb3J0IGNvbnN0IGNvbmZpZyA9IHtcbiAgbWF0Y2hlcjogW1xuICAgIC8qXG4gICAgICogTWF0Y2ggYWxsIHJlcXVlc3QgcGF0aHMgZXhjZXB0IGZvciB0aGUgb25lcyBzdGFydGluZyB3aXRoOlxuICAgICAqIC0gYXBpL2F1dGggKGF1dGggZW5kcG9pbnRzKVxuICAgICAqIC0gX25leHQvc3RhdGljIChzdGF0aWMgZmlsZXMpXG4gICAgICogLSBfbmV4dC9pbWFnZSAoaW1hZ2Ugb3B0aW1pemF0aW9uIGZpbGVzKVxuICAgICAqIC0gZmF2aWNvbi5pY28gKGZhdmljb24gZmlsZSlcbiAgICAgKiAtIHB1YmxpYyBmb2xkZXJcbiAgICAgKi9cbiAgICBcIi8oKD8hYXBpL2F1dGh8X25leHQvc3RhdGljfF9uZXh0L2ltYWdlfGZhdmljb24uaWNvfHVwbG9hZHN8ZXhwb3J0c3xhdXRoKS4qKVwiLFxuICBdLFxufTtcbiJdLCJuYW1lcyI6WyJ3aXRoQXV0aCIsIk5leHRSZXNwb25zZSIsIkRvbWFpblNlcnZpY2UiLCJtaWRkbGV3YXJlIiwicmVxIiwicGF0aG5hbWUiLCJuZXh0VXJsIiwidG9rZW4iLCJuZXh0YXV0aCIsImZvcndhcmRlZEhvc3QiLCJoZWFkZXJzIiwiZ2V0IiwiaG9zdG5hbWUiLCJVUkwiLCJ1cmwiLCJjb25zb2xlIiwibG9nIiwiaG9zdCIsImluY2x1ZGVzIiwibmV4dCIsImNsZWFuRG9tYWluIiwidG9Mb3dlckNhc2UiLCJyZXBsYWNlIiwibWFpbkFwcERvbWFpbiIsInByb2Nlc3MiLCJlbnYiLCJORVhUQVVUSF9VUkwiLCJzcGxpdCIsImlzTWFpbkRvbWFpbiIsImludGVybmFsT3JpZ2luIiwiZG9tYWluTG9va3VwVXJsIiwic2VhcmNoUGFyYW1zIiwic2V0IiwidG9TdHJpbmciLCJkb21haW5SZXNwb25zZSIsImZldGNoIiwib2siLCJkb21haW5EYXRhIiwianNvbiIsInN1Y2Nlc3MiLCJvcmdhbml6YXRpb24iLCJyZXF1ZXN0SGVhZGVycyIsIkhlYWRlcnMiLCJfaWQiLCJuYW1lIiwidXNlck9yZ0lkIiwib3JnYW5pemF0aW9uSWQiLCJkb21haW5PcmdJZCIsInZhbGlkYXRlVXNlckFjY2VzcyIsInN0YXJ0c1dpdGgiLCJsb2dpblVybCIsInJlZGlyZWN0IiwiY2xvbmUiLCJvcmdEb21haW4iLCJkb21haW4iLCJyZXdyaXRlIiwicmVxdWVzdCIsImRvY3VtZW50SWRQYXR0ZXJuIiwidGVzdCIsInB1YmxpY0RvY1BhdHRlcm4iLCJSZWdFeHAiLCJtYXRjaCIsImRvY0lkIiwiSlNPTiIsInN0cmluZ2lmeSIsImVycm9yIiwibWVzc2FnZSIsImNvZGUiLCJzdGF0dXMiLCJjYWxsYmFja3MiLCJhdXRob3JpemVkIiwicHVibGljUm91dGVzIiwicHJvdGVjdGVkUm91dGVzIiwic29tZSIsInJvdXRlIiwicmVxdWlyZXNBdXRoIiwicm9sZSIsImNvbmZpZyIsIm1hdGNoZXIiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(middleware)/./src/middleware.ts\n");

/***/ })

});