"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("src/middleware",{

/***/ "(middleware)/./src/middleware.ts":
/*!***************************!*\
  !*** ./src/middleware.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__)\n/* harmony export */ });\n/* harmony import */ var next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next-auth/middleware */ \"(middleware)/./node_modules/next-auth/middleware.js\");\n/* harmony import */ var next_auth_middleware__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/server */ \"(middleware)/./node_modules/next/dist/esm/api/server.js\");\n/* harmony import */ var _lib_domain__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/domain */ \"(middleware)/./src/lib/domain.ts\");\n\n\n\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_auth_middleware__WEBPACK_IMPORTED_MODULE_0__.withAuth)(async function middleware(req) {\n    const { pathname } = req.nextUrl;\n    const token = req.nextauth.token;\n    // Get hostname from X-Forwarded-Host (Nginx proxy) or fall back to req.nextUrl.hostname\n    const forwardedHost = req.headers.get(\"x-forwarded-host\") || req.headers.get(\"host\");\n    const hostname = forwardedHost || req.nextUrl.hostname;\n    console.log(`[Middleware] Request: ${hostname}${pathname}`, {\n        \"x-forwarded-host\": req.headers.get(\"x-forwarded-host\"),\n        host: req.headers.get(\"host\"),\n        \"nextUrl.hostname\": req.nextUrl.hostname\n    });\n    // Skip processing for localhost and development\n    if (!req.headers.get(\"x-middleware-request\") && (hostname === \"localhost\" || hostname.includes(\"localhost\"))) {\n        console.log(\"[Middleware] Skipping external localhost\");\n        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next();\n    }\n    // Simple domain extraction\n    const cleanDomain = hostname.toLowerCase().replace(/^www\\./, \"\");\n    // Check if this is a custom domain (not our main application domains)\n    const mainAppDomain = process.env.NEXTAUTH_URL?.replace(/^https?:\\/\\//, \"\").split(\"/\")[0] || \"eaip.flyclim.com\";\n    const isMainDomain = hostname === mainAppDomain || hostname === \"eaip.flyclim.com\" || // Always treat eaip.flyclim.com as main domain\n    hostname === \"localhost\" || hostname === \"0.0.0.0\" || hostname.includes(\"localhost\") || hostname.includes(\"vercel.app\") || hostname.includes(\"netlify.app\");\n    console.log(`[Middleware] Domain check:`, {\n        hostname,\n        cleanDomain,\n        mainAppDomain,\n        isMainDomain\n    });\n    // Handle tenant-specific domain routing\n    if (!isMainDomain && cleanDomain !== \"localhost\") {\n        try {\n            // For custom domains, use an API call to lookup organization\n            // Use localhost for internal API calls to avoid SSL issues\n            const internalOrigin = \"http://localhost:3000\";\n            const domainLookupUrl = new URL(\"/api/organizations/by-domain\", internalOrigin);\n            domainLookupUrl.searchParams.set(\"domain\", cleanDomain);\n            console.log(\"[Middleware] Fetching org data from:\", domainLookupUrl.toString());\n            const domainResponse = await fetch(domainLookupUrl.toString(), {\n                headers: {\n                    \"x-middleware-request\": \"true\"\n                }\n            });\n            if (domainResponse.ok) {\n                const domainData = await domainResponse.json();\n                if (domainData.success && domainData.organization) {\n                    // Set organization context headers\n                    const requestHeaders = new Headers(req.headers);\n                    requestHeaders.set(\"x-tenant-domain\", cleanDomain);\n                    requestHeaders.set(\"x-tenant-org-id\", domainData.organization._id);\n                    requestHeaders.set(\"x-tenant-org-name\", domainData.organization.name);\n                    // For authenticated users, validate they belong to this organization\n                    if (token) {\n                        const userOrgId = token.organizationId;\n                        const domainOrgId = domainData.organization._id;\n                        // Block cross-tenant access\n                        if (!_lib_domain__WEBPACK_IMPORTED_MODULE_2__.DomainService.validateUserAccess(userOrgId, domainOrgId) && !pathname.startsWith(\"/auth/signin\")) {\n                            console.log(`Access denied: User org ${userOrgId} accessing domain org ${domainOrgId}`);\n                            // Redirect to domain-specific login\n                            const loginUrl = new URL(\"/auth/signin\", req.url);\n                            loginUrl.searchParams.set(\"error\", \"unauthorized\");\n                            loginUrl.searchParams.set(\"callbackUrl\", pathname);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(loginUrl);\n                        }\n                    }\n                    // Custom domains ONLY serve public pages\n                    // Redirect all custom domain traffic to public eAIP pages\n                    const url = req.nextUrl.clone();\n                    const orgDomain = domainData.organization.domain;\n                    // Map root to public organization page\n                    if (pathname === \"/\") {\n                        url.pathname = `/public/${orgDomain}`;\n                        console.log(`[Custom Domain] Root rewrite: ${hostname}/ → ${url.pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Map document IDs directly to public document pages\n                    // Pattern: /{documentId} → /public/{domain}/{documentId}\n                    const documentIdPattern = /^\\/([a-f0-9]{24})$/i; // MongoDB ObjectId pattern\n                    if (documentIdPattern.test(pathname)) {\n                        url.pathname = `/public/${orgDomain}${pathname}`;\n                        console.log(`[Custom Domain] Document rewrite: ${hostname}${pathname} → ${url.pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Handle /public routes on custom domains\n                    if (pathname.startsWith(\"/public\")) {\n                        // If accessing /public/{orgDomain} on custom domain, redirect to root\n                        if (pathname === `/public/${orgDomain}`) {\n                            console.log(`[Custom Domain] Redirect /public/${orgDomain} → /`);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(new URL(\"/\", req.url));\n                        }\n                        // If accessing /public/{orgDomain}/{documentId}, redirect to /{documentId}\n                        const publicDocPattern = new RegExp(`^/public/${orgDomain.replace(\".\", \"\\\\.\")}/([a-f0-9]{24})$`, \"i\");\n                        const match = pathname.match(publicDocPattern);\n                        if (match) {\n                            const docId = match[1];\n                            console.log(`[Custom Domain] Redirect /public/${orgDomain}/${docId} → /${docId}`);\n                            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.redirect(new URL(`/${docId}`, req.url));\n                        }\n                        console.log(`[Custom Domain] Public route passthrough: ${pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.rewrite(url, {\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Allow API calls for public data\n                    if (pathname.startsWith(\"/api/public\")) {\n                        console.log(`[Custom Domain] API passthrough: ${pathname}`);\n                        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next({\n                            request: {\n                                headers: requestHeaders\n                            }\n                        });\n                    }\n                    // Block all other routes on custom domains (admin, dashboard, auth, etc.)\n                    // Users must access the main app domain (eaip.flyclim.com) for these features\n                    console.log(`Custom domain ${cleanDomain} blocked access to: ${pathname}`);\n                    return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                        error: \"Access Denied\",\n                        message: `This custom domain only provides public eAIP access. For administration, please visit the main application at ${process.env.NEXTAUTH_URL || \"https://eaip.flyclim.com\"}`,\n                        code: \"CUSTOM_DOMAIN_PUBLIC_ONLY\"\n                    }), {\n                        status: 403,\n                        headers: {\n                            \"content-type\": \"application/json\"\n                        }\n                    });\n                }\n            }\n            // Domain not found in our system\n            return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                error: \"Domain not configured\",\n                message: `The domain ${cleanDomain} is not associated with any organization.`,\n                code: \"DOMAIN_NOT_FOUND\"\n            }), {\n                status: 404,\n                headers: {\n                    \"content-type\": \"application/json\"\n                }\n            });\n        } catch (error) {\n            console.error(\"Domain lookup error:\", error);\n            return new next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse(JSON.stringify({\n                error: \"Domain lookup failed\",\n                message: \"Unable to resolve domain configuration.\",\n                code: \"DOMAIN_LOOKUP_ERROR\"\n            }), {\n                status: 500,\n                headers: {\n                    \"content-type\": \"application/json\"\n                }\n            });\n        }\n    }\n    // Main domain handling - no special tenant validation needed\n    return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.next();\n}, {\n    callbacks: {\n        authorized: ({ token, req })=>{\n            const { pathname } = req.nextUrl;\n            // Define route categories\n            const publicRoutes = [\n                \"/public\",\n                \"/eaip\",\n                \"/api/public\",\n                \"/auth/signin\",\n                \"/auth/signup\",\n                \"/auth/error\",\n                \"/_next\",\n                \"/favicon.ico\"\n            ];\n            const protectedRoutes = [\n                \"/admin\",\n                \"/dashboard\",\n                \"/documents\",\n                \"/versions\",\n                \"/exports\",\n                \"/profile\",\n                \"/organization\",\n                \"/api/admin\",\n                \"/api/documents\",\n                \"/api/users\"\n            ];\n            // Allow public routes without authentication\n            if (publicRoutes.some((route)=>pathname.startsWith(route))) {\n                return true;\n            }\n            // Check if route requires authentication\n            const requiresAuth = protectedRoutes.some((route)=>pathname.startsWith(route));\n            if (requiresAuth) {\n                // Require valid token for protected routes\n                if (!token) {\n                    return false;\n                }\n                // Additional role-based checks\n                if (pathname.startsWith(\"/admin\") && token.role !== \"super_admin\") {\n                    return false;\n                }\n                return true;\n            }\n            // Default: allow access to unspecified routes\n            return true;\n        }\n    }\n}));\nconst config = {\n    matcher: [\n        /*\n     * Match all request paths except for the ones starting with:\n     * - api/auth (auth endpoints)\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - public folder\n     */ \"/((?!api/auth|_next/static|_next/image|favicon.ico|uploads|exports|auth).*)\"\n    ]\n};\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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cyI6WyJ3ZWJwYWNrOi8vX05fRS8uL3NyYy9taWRkbGV3YXJlLnRzP2QxOTkiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgd2l0aEF1dGggfSBmcm9tIFwibmV4dC1hdXRoL21pZGRsZXdhcmVcIjtcbmltcG9ydCB7IE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xuaW1wb3J0IHsgRG9tYWluU2VydmljZSB9IGZyb20gXCJAL2xpYi9kb21haW5cIjtcblxuZXhwb3J0IGRlZmF1bHQgd2l0aEF1dGgoXG4gIGFzeW5jIGZ1bmN0aW9uIG1pZGRsZXdhcmUocmVxKSB7XG4gICAgY29uc3QgeyBwYXRobmFtZSB9ID0gcmVxLm5leHRVcmw7XG4gICAgY29uc3QgdG9rZW4gPSByZXEubmV4dGF1dGgudG9rZW47XG5cbiAgICAvLyBHZXQgaG9zdG5hbWUgZnJvbSBYLUZvcndhcmRlZC1Ib3N0IChOZ2lueCBwcm94eSkgb3IgZmFsbCBiYWNrIHRvIHJlcS5uZXh0VXJsLmhvc3RuYW1lXG4gICAgY29uc3QgZm9yd2FyZGVkSG9zdCA9XG4gICAgICByZXEuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpIHx8IHJlcS5oZWFkZXJzLmdldChcImhvc3RcIik7XG4gICAgY29uc3QgaG9zdG5hbWUgPSBmb3J3YXJkZWRIb3N0IHx8IHJlcS5uZXh0VXJsLmhvc3RuYW1lO1xuXG4gICAgY29uc29sZS5sb2coYFtNaWRkbGV3YXJlXSBSZXF1ZXN0OiAke2hvc3RuYW1lfSR7cGF0aG5hbWV9YCwge1xuICAgICAgXCJ4LWZvcndhcmRlZC1ob3N0XCI6IHJlcS5oZWFkZXJzLmdldChcIngtZm9yd2FyZGVkLWhvc3RcIiksXG4gICAgICBob3N0OiByZXEuaGVhZGVycy5nZXQoXCJob3N0XCIpLFxuICAgICAgXCJuZXh0VXJsLmhvc3RuYW1lXCI6IHJlcS5uZXh0VXJsLmhvc3RuYW1lLFxuICAgIH0pO1xuXG4gICAgLy8gU2tpcCBwcm9jZXNzaW5nIGZvciBsb2NhbGhvc3QgYW5kIGRldmVsb3BtZW50XG4gICAgaWYgKFxuICAgICAgIXJlcS5oZWFkZXJzLmdldChcIngtbWlkZGxld2FyZS1yZXF1ZXN0XCIpICYmXG4gICAgICAoaG9zdG5hbWUgPT09IFwibG9jYWxob3N0XCIgfHwgaG9zdG5hbWUuaW5jbHVkZXMoXCJsb2NhbGhvc3RcIikpXG4gICAgKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIltNaWRkbGV3YXJlXSBTa2lwcGluZyBleHRlcm5hbCBsb2NhbGhvc3RcIik7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLm5leHQoKTtcbiAgICB9XG5cbiAgICAvLyBTaW1wbGUgZG9tYWluIGV4dHJhY3Rpb25cbiAgICBjb25zdCBjbGVhbkRvbWFpbiA9IGhvc3RuYW1lLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXnd3d1xcLi8sIFwiXCIpO1xuXG4gICAgLy8gQ2hlY2sgaWYgdGhpcyBpcyBhIGN1c3RvbSBkb21haW4gKG5vdCBvdXIgbWFpbiBhcHBsaWNhdGlvbiBkb21haW5zKVxuICAgIGNvbnN0IG1haW5BcHBEb21haW4gPVxuICAgICAgcHJvY2Vzcy5lbnYuTkVYVEFVVEhfVVJMPy5yZXBsYWNlKC9eaHR0cHM/OlxcL1xcLy8sIFwiXCIpLnNwbGl0KFwiL1wiKVswXSB8fFxuICAgICAgXCJlYWlwLmZseWNsaW0uY29tXCI7XG4gICAgY29uc3QgaXNNYWluRG9tYWluID1cbiAgICAgIGhvc3RuYW1lID09PSBtYWluQXBwRG9tYWluIHx8XG4gICAgICBob3N0bmFtZSA9PT0gXCJlYWlwLmZseWNsaW0uY29tXCIgfHwgLy8gQWx3YXlzIHRyZWF0IGVhaXAuZmx5Y2xpbS5jb20gYXMgbWFpbiBkb21haW5cbiAgICAgIGhvc3RuYW1lID09PSBcImxvY2FsaG9zdFwiIHx8XG4gICAgICBob3N0bmFtZSA9PT0gXCIwLjAuMC4wXCIgfHxcbiAgICAgIGhvc3RuYW1lLmluY2x1ZGVzKFwibG9jYWxob3N0XCIpIHx8XG4gICAgICBob3N0bmFtZS5pbmNsdWRlcyhcInZlcmNlbC5hcHBcIikgfHxcbiAgICAgIGhvc3RuYW1lLmluY2x1ZGVzKFwibmV0bGlmeS5hcHBcIik7XG5cbiAgICBjb25zb2xlLmxvZyhgW01pZGRsZXdhcmVdIERvbWFpbiBjaGVjazpgLCB7XG4gICAgICBob3N0bmFtZSxcbiAgICAgIGNsZWFuRG9tYWluLFxuICAgICAgbWFpbkFwcERvbWFpbixcbiAgICAgIGlzTWFpbkRvbWFpbixcbiAgICB9KTtcblxuICAgIC8vIEhhbmRsZSB0ZW5hbnQtc3BlY2lmaWMgZG9tYWluIHJvdXRpbmdcbiAgICBpZiAoIWlzTWFpbkRvbWFpbiAmJiBjbGVhbkRvbWFpbiAhPT0gXCJsb2NhbGhvc3RcIikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gRm9yIGN1c3RvbSBkb21haW5zLCB1c2UgYW4gQVBJIGNhbGwgdG8gbG9va3VwIG9yZ2FuaXphdGlvblxuICAgICAgICAvLyBVc2UgbG9jYWxob3N0IGZvciBpbnRlcm5hbCBBUEkgY2FsbHMgdG8gYXZvaWQgU1NMIGlzc3Vlc1xuICAgICAgICBjb25zdCBpbnRlcm5hbE9yaWdpbiA9IFwiaHR0cDovL2xvY2FsaG9zdDozMDAwXCI7XG4gICAgICAgIGNvbnN0IGRvbWFpbkxvb2t1cFVybCA9IG5ldyBVUkwoXG4gICAgICAgICAgXCIvYXBpL29yZ2FuaXphdGlvbnMvYnktZG9tYWluXCIsXG4gICAgICAgICAgaW50ZXJuYWxPcmlnaW5cbiAgICAgICAgKTtcbiAgICAgICAgZG9tYWluTG9va3VwVXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJkb21haW5cIiwgY2xlYW5Eb21haW4pO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgIFwiW01pZGRsZXdhcmVdIEZldGNoaW5nIG9yZyBkYXRhIGZyb206XCIsXG4gICAgICAgICAgZG9tYWluTG9va3VwVXJsLnRvU3RyaW5nKClcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBkb21haW5SZXNwb25zZSA9IGF3YWl0IGZldGNoKGRvbWFpbkxvb2t1cFVybC50b1N0cmluZygpLCB7XG4gICAgICAgICAgaGVhZGVyczogeyBcIngtbWlkZGxld2FyZS1yZXF1ZXN0XCI6IFwidHJ1ZVwiIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChkb21haW5SZXNwb25zZS5vaykge1xuICAgICAgICAgIGNvbnN0IGRvbWFpbkRhdGEgPSBhd2FpdCBkb21haW5SZXNwb25zZS5qc29uKCk7XG5cbiAgICAgICAgICBpZiAoZG9tYWluRGF0YS5zdWNjZXNzICYmIGRvbWFpbkRhdGEub3JnYW5pemF0aW9uKSB7XG4gICAgICAgICAgICAvLyBTZXQgb3JnYW5pemF0aW9uIGNvbnRleHQgaGVhZGVyc1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdEhlYWRlcnMgPSBuZXcgSGVhZGVycyhyZXEuaGVhZGVycyk7XG4gICAgICAgICAgICByZXF1ZXN0SGVhZGVycy5zZXQoXCJ4LXRlbmFudC1kb21haW5cIiwgY2xlYW5Eb21haW4pO1xuICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnMuc2V0KFwieC10ZW5hbnQtb3JnLWlkXCIsIGRvbWFpbkRhdGEub3JnYW5pemF0aW9uLl9pZCk7XG4gICAgICAgICAgICByZXF1ZXN0SGVhZGVycy5zZXQoXG4gICAgICAgICAgICAgIFwieC10ZW5hbnQtb3JnLW5hbWVcIixcbiAgICAgICAgICAgICAgZG9tYWluRGF0YS5vcmdhbml6YXRpb24ubmFtZVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgLy8gRm9yIGF1dGhlbnRpY2F0ZWQgdXNlcnMsIHZhbGlkYXRlIHRoZXkgYmVsb25nIHRvIHRoaXMgb3JnYW5pemF0aW9uXG4gICAgICAgICAgICBpZiAodG9rZW4pIHtcbiAgICAgICAgICAgICAgY29uc3QgdXNlck9yZ0lkID0gdG9rZW4ub3JnYW5pemF0aW9uSWQgYXMgc3RyaW5nO1xuICAgICAgICAgICAgICBjb25zdCBkb21haW5PcmdJZCA9IGRvbWFpbkRhdGEub3JnYW5pemF0aW9uLl9pZDtcblxuICAgICAgICAgICAgICAvLyBCbG9jayBjcm9zcy10ZW5hbnQgYWNjZXNzXG4gICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAhRG9tYWluU2VydmljZS52YWxpZGF0ZVVzZXJBY2Nlc3ModXNlck9yZ0lkLCBkb21haW5PcmdJZCkgJiZcbiAgICAgICAgICAgICAgICAhcGF0aG5hbWUuc3RhcnRzV2l0aChcIi9hdXRoL3NpZ25pblwiKVxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICAgICAgICAgIGBBY2Nlc3MgZGVuaWVkOiBVc2VyIG9yZyAke3VzZXJPcmdJZH0gYWNjZXNzaW5nIGRvbWFpbiBvcmcgJHtkb21haW5PcmdJZH1gXG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgIC8vIFJlZGlyZWN0IHRvIGRvbWFpbi1zcGVjaWZpYyBsb2dpblxuICAgICAgICAgICAgICAgIGNvbnN0IGxvZ2luVXJsID0gbmV3IFVSTChcIi9hdXRoL3NpZ25pblwiLCByZXEudXJsKTtcbiAgICAgICAgICAgICAgICBsb2dpblVybC5zZWFyY2hQYXJhbXMuc2V0KFwiZXJyb3JcIiwgXCJ1bmF1dGhvcml6ZWRcIik7XG4gICAgICAgICAgICAgICAgbG9naW5Vcmwuc2VhcmNoUGFyYW1zLnNldChcImNhbGxiYWNrVXJsXCIsIHBhdGhuYW1lKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmVkaXJlY3QobG9naW5VcmwpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEN1c3RvbSBkb21haW5zIE9OTFkgc2VydmUgcHVibGljIHBhZ2VzXG4gICAgICAgICAgICAvLyBSZWRpcmVjdCBhbGwgY3VzdG9tIGRvbWFpbiB0cmFmZmljIHRvIHB1YmxpYyBlQUlQIHBhZ2VzXG4gICAgICAgICAgICBjb25zdCB1cmwgPSByZXEubmV4dFVybC5jbG9uZSgpO1xuICAgICAgICAgICAgY29uc3Qgb3JnRG9tYWluID0gZG9tYWluRGF0YS5vcmdhbml6YXRpb24uZG9tYWluO1xuXG4gICAgICAgICAgICAvLyBNYXAgcm9vdCB0byBwdWJsaWMgb3JnYW5pemF0aW9uIHBhZ2VcbiAgICAgICAgICAgIGlmIChwYXRobmFtZSA9PT0gXCIvXCIpIHtcbiAgICAgICAgICAgICAgdXJsLnBhdGhuYW1lID0gYC9wdWJsaWMvJHtvcmdEb21haW59YDtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgYFtDdXN0b20gRG9tYWluXSBSb290IHJld3JpdGU6ICR7aG9zdG5hbWV9LyDihpIgJHt1cmwucGF0aG5hbWV9YFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLnJld3JpdGUodXJsLCB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdDogeyBoZWFkZXJzOiByZXF1ZXN0SGVhZGVycyB9LFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gTWFwIGRvY3VtZW50IElEcyBkaXJlY3RseSB0byBwdWJsaWMgZG9jdW1lbnQgcGFnZXNcbiAgICAgICAgICAgIC8vIFBhdHRlcm46IC97ZG9jdW1lbnRJZH0g4oaSIC9wdWJsaWMve2RvbWFpbn0ve2RvY3VtZW50SWR9XG4gICAgICAgICAgICBjb25zdCBkb2N1bWVudElkUGF0dGVybiA9IC9eXFwvKFthLWYwLTldezI0fSkkL2k7IC8vIE1vbmdvREIgT2JqZWN0SWQgcGF0dGVyblxuICAgICAgICAgICAgaWYgKGRvY3VtZW50SWRQYXR0ZXJuLnRlc3QocGF0aG5hbWUpKSB7XG4gICAgICAgICAgICAgIHVybC5wYXRobmFtZSA9IGAvcHVibGljLyR7b3JnRG9tYWlufSR7cGF0aG5hbWV9YDtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgYFtDdXN0b20gRG9tYWluXSBEb2N1bWVudCByZXdyaXRlOiAke2hvc3RuYW1lfSR7cGF0aG5hbWV9IOKGkiAke3VybC5wYXRobmFtZX1gXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmV3cml0ZSh1cmwsIHtcbiAgICAgICAgICAgICAgICByZXF1ZXN0OiB7IGhlYWRlcnM6IHJlcXVlc3RIZWFkZXJzIH0sXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBIYW5kbGUgL3B1YmxpYyByb3V0ZXMgb24gY3VzdG9tIGRvbWFpbnNcbiAgICAgICAgICAgIGlmIChwYXRobmFtZS5zdGFydHNXaXRoKFwiL3B1YmxpY1wiKSkge1xuICAgICAgICAgICAgICAvLyBJZiBhY2Nlc3NpbmcgL3B1YmxpYy97b3JnRG9tYWlufSBvbiBjdXN0b20gZG9tYWluLCByZWRpcmVjdCB0byByb290XG4gICAgICAgICAgICAgIGlmIChwYXRobmFtZSA9PT0gYC9wdWJsaWMvJHtvcmdEb21haW59YCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgICAgYFtDdXN0b20gRG9tYWluXSBSZWRpcmVjdCAvcHVibGljLyR7b3JnRG9tYWlufSDihpIgL2BcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UucmVkaXJlY3QobmV3IFVSTChcIi9cIiwgcmVxLnVybCkpO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgLy8gSWYgYWNjZXNzaW5nIC9wdWJsaWMve29yZ0RvbWFpbn0ve2RvY3VtZW50SWR9LCByZWRpcmVjdCB0byAve2RvY3VtZW50SWR9XG4gICAgICAgICAgICAgIGNvbnN0IHB1YmxpY0RvY1BhdHRlcm4gPSBuZXcgUmVnRXhwKFxuICAgICAgICAgICAgICAgIGBeL3B1YmxpYy8ke29yZ0RvbWFpbi5yZXBsYWNlKFwiLlwiLCBcIlxcXFwuXCIpfS8oW2EtZjAtOV17MjR9KSRgLFxuICAgICAgICAgICAgICAgIFwiaVwiXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gcGF0aG5hbWUubWF0Y2gocHVibGljRG9jUGF0dGVybik7XG4gICAgICAgICAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRvY0lkID0gbWF0Y2hbMV07XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgICBgW0N1c3RvbSBEb21haW5dIFJlZGlyZWN0IC9wdWJsaWMvJHtvcmdEb21haW59LyR7ZG9jSWR9IOKGkiAvJHtkb2NJZH1gXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLnJlZGlyZWN0KG5ldyBVUkwoYC8ke2RvY0lkfWAsIHJlcS51cmwpKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICAgICAgICAgIGBbQ3VzdG9tIERvbWFpbl0gUHVibGljIHJvdXRlIHBhc3N0aHJvdWdoOiAke3BhdGhuYW1lfWBcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5yZXdyaXRlKHVybCwge1xuICAgICAgICAgICAgICAgIHJlcXVlc3Q6IHsgaGVhZGVyczogcmVxdWVzdEhlYWRlcnMgfSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEFsbG93IEFQSSBjYWxscyBmb3IgcHVibGljIGRhdGFcbiAgICAgICAgICAgIGlmIChwYXRobmFtZS5zdGFydHNXaXRoKFwiL2FwaS9wdWJsaWNcIikpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtDdXN0b20gRG9tYWluXSBBUEkgcGFzc3Rocm91Z2g6ICR7cGF0aG5hbWV9YCk7XG4gICAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UubmV4dCh7XG4gICAgICAgICAgICAgICAgcmVxdWVzdDogeyBoZWFkZXJzOiByZXF1ZXN0SGVhZGVycyB9LFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gQmxvY2sgYWxsIG90aGVyIHJvdXRlcyBvbiBjdXN0b20gZG9tYWlucyAoYWRtaW4sIGRhc2hib2FyZCwgYXV0aCwgZXRjLilcbiAgICAgICAgICAgIC8vIFVzZXJzIG11c3QgYWNjZXNzIHRoZSBtYWluIGFwcCBkb21haW4gKGVhaXAuZmx5Y2xpbS5jb20pIGZvciB0aGVzZSBmZWF0dXJlc1xuICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgIGBDdXN0b20gZG9tYWluICR7Y2xlYW5Eb21haW59IGJsb2NrZWQgYWNjZXNzIHRvOiAke3BhdGhuYW1lfWBcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4gbmV3IE5leHRSZXNwb25zZShcbiAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgIGVycm9yOiBcIkFjY2VzcyBEZW5pZWRcIixcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBgVGhpcyBjdXN0b20gZG9tYWluIG9ubHkgcHJvdmlkZXMgcHVibGljIGVBSVAgYWNjZXNzLiBGb3IgYWRtaW5pc3RyYXRpb24sIHBsZWFzZSB2aXNpdCB0aGUgbWFpbiBhcHBsaWNhdGlvbiBhdCAke1xuICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuTkVYVEFVVEhfVVJMIHx8IFwiaHR0cHM6Ly9lYWlwLmZseWNsaW0uY29tXCJcbiAgICAgICAgICAgICAgICB9YCxcbiAgICAgICAgICAgICAgICBjb2RlOiBcIkNVU1RPTV9ET01BSU5fUFVCTElDX09OTFlcIixcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDQwMyxcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7IFwiY29udGVudC10eXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiIH0sXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gRG9tYWluIG5vdCBmb3VuZCBpbiBvdXIgc3lzdGVtXG4gICAgICAgIHJldHVybiBuZXcgTmV4dFJlc3BvbnNlKFxuICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIGVycm9yOiBcIkRvbWFpbiBub3QgY29uZmlndXJlZFwiLFxuICAgICAgICAgICAgbWVzc2FnZTogYFRoZSBkb21haW4gJHtjbGVhbkRvbWFpbn0gaXMgbm90IGFzc29jaWF0ZWQgd2l0aCBhbnkgb3JnYW5pemF0aW9uLmAsXG4gICAgICAgICAgICBjb2RlOiBcIkRPTUFJTl9OT1RfRk9VTkRcIixcbiAgICAgICAgICB9KSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBzdGF0dXM6IDQwNCxcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgXCJjb250ZW50LXR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRG9tYWluIGxvb2t1cCBlcnJvcjpcIiwgZXJyb3IpO1xuICAgICAgICByZXR1cm4gbmV3IE5leHRSZXNwb25zZShcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBlcnJvcjogXCJEb21haW4gbG9va3VwIGZhaWxlZFwiLFxuICAgICAgICAgICAgbWVzc2FnZTogXCJVbmFibGUgdG8gcmVzb2x2ZSBkb21haW4gY29uZmlndXJhdGlvbi5cIixcbiAgICAgICAgICAgIGNvZGU6IFwiRE9NQUlOX0xPT0tVUF9FUlJPUlwiLFxuICAgICAgICAgIH0pLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHN0YXR1czogNTAwLFxuICAgICAgICAgICAgaGVhZGVyczogeyBcImNvbnRlbnQtdHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBNYWluIGRvbWFpbiBoYW5kbGluZyAtIG5vIHNwZWNpYWwgdGVuYW50IHZhbGlkYXRpb24gbmVlZGVkXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5uZXh0KCk7XG4gIH0sXG4gIHtcbiAgICBjYWxsYmFja3M6IHtcbiAgICAgIGF1dGhvcml6ZWQ6ICh7IHRva2VuLCByZXEgfSkgPT4ge1xuICAgICAgICBjb25zdCB7IHBhdGhuYW1lIH0gPSByZXEubmV4dFVybDtcblxuICAgICAgICAvLyBEZWZpbmUgcm91dGUgY2F0ZWdvcmllc1xuICAgICAgICBjb25zdCBwdWJsaWNSb3V0ZXMgPSBbXG4gICAgICAgICAgXCIvcHVibGljXCIsXG4gICAgICAgICAgXCIvZWFpcFwiLFxuICAgICAgICAgIFwiL2FwaS9wdWJsaWNcIixcbiAgICAgICAgICBcIi9hdXRoL3NpZ25pblwiLFxuICAgICAgICAgIFwiL2F1dGgvc2lnbnVwXCIsXG4gICAgICAgICAgXCIvYXV0aC9lcnJvclwiLFxuICAgICAgICAgIFwiL19uZXh0XCIsXG4gICAgICAgICAgXCIvZmF2aWNvbi5pY29cIixcbiAgICAgICAgXTtcblxuICAgICAgICBjb25zdCBwcm90ZWN0ZWRSb3V0ZXMgPSBbXG4gICAgICAgICAgXCIvYWRtaW5cIixcbiAgICAgICAgICBcIi9kYXNoYm9hcmRcIixcbiAgICAgICAgICBcIi9kb2N1bWVudHNcIixcbiAgICAgICAgICBcIi92ZXJzaW9uc1wiLFxuICAgICAgICAgIFwiL2V4cG9ydHNcIixcbiAgICAgICAgICBcIi9wcm9maWxlXCIsXG4gICAgICAgICAgXCIvb3JnYW5pemF0aW9uXCIsXG4gICAgICAgICAgXCIvYXBpL2FkbWluXCIsXG4gICAgICAgICAgXCIvYXBpL2RvY3VtZW50c1wiLFxuICAgICAgICAgIFwiL2FwaS91c2Vyc1wiLFxuICAgICAgICBdO1xuXG4gICAgICAgIC8vIEFsbG93IHB1YmxpYyByb3V0ZXMgd2l0aG91dCBhdXRoZW50aWNhdGlvblxuICAgICAgICBpZiAocHVibGljUm91dGVzLnNvbWUoKHJvdXRlKSA9PiBwYXRobmFtZS5zdGFydHNXaXRoKHJvdXRlKSkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGlmIHJvdXRlIHJlcXVpcmVzIGF1dGhlbnRpY2F0aW9uXG4gICAgICAgIGNvbnN0IHJlcXVpcmVzQXV0aCA9IHByb3RlY3RlZFJvdXRlcy5zb21lKChyb3V0ZSkgPT5cbiAgICAgICAgICBwYXRobmFtZS5zdGFydHNXaXRoKHJvdXRlKVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChyZXF1aXJlc0F1dGgpIHtcbiAgICAgICAgICAvLyBSZXF1aXJlIHZhbGlkIHRva2VuIGZvciBwcm90ZWN0ZWQgcm91dGVzXG4gICAgICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIEFkZGl0aW9uYWwgcm9sZS1iYXNlZCBjaGVja3NcbiAgICAgICAgICBpZiAocGF0aG5hbWUuc3RhcnRzV2l0aChcIi9hZG1pblwiKSAmJiB0b2tlbi5yb2xlICE9PSBcInN1cGVyX2FkbWluXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIERlZmF1bHQ6IGFsbG93IGFjY2VzcyB0byB1bnNwZWNpZmllZCByb3V0ZXNcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9LFxuICAgIH0sXG4gIH1cbik7XG5cbmV4cG9ydCBjb25zdCBjb25maWcgPSB7XG4gIG1hdGNoZXI6IFtcbiAgICAvKlxuICAgICAqIE1hdGNoIGFsbCByZXF1ZXN0IHBhdGhzIGV4Y2VwdCBmb3IgdGhlIG9uZXMgc3RhcnRpbmcgd2l0aDpcbiAgICAgKiAtIGFwaS9hdXRoIChhdXRoIGVuZHBvaW50cylcbiAgICAgKiAtIF9uZXh0L3N0YXRpYyAoc3RhdGljIGZpbGVzKVxuICAgICAqIC0gX25leHQvaW1hZ2UgKGltYWdlIG9wdGltaXphdGlvbiBmaWxlcylcbiAgICAgKiAtIGZhdmljb24uaWNvIChmYXZpY29uIGZpbGUpXG4gICAgICogLSBwdWJsaWMgZm9sZGVyXG4gICAgICovXG4gICAgXCIvKCg/IWFwaS9hdXRofF9uZXh0L3N0YXRpY3xfbmV4dC9pbWFnZXxmYXZpY29uLmljb3x1cGxvYWRzfGV4cG9ydHN8YXV0aCkuKilcIixcbiAgXSxcbn07XG4iXSwibmFtZXMiOlsid2l0aEF1dGgiLCJOZXh0UmVzcG9uc2UiLCJEb21haW5TZXJ2aWNlIiwibWlkZGxld2FyZSIsInJlcSIsInBhdGhuYW1lIiwibmV4dFVybCIsInRva2VuIiwibmV4dGF1dGgiLCJmb3J3YXJkZWRIb3N0IiwiaGVhZGVycyIsImdldCIsImhvc3RuYW1lIiwiY29uc29sZSIsImxvZyIsImhvc3QiLCJpbmNsdWRlcyIsIm5leHQiLCJjbGVhbkRvbWFpbiIsInRvTG93ZXJDYXNlIiwicmVwbGFjZSIsIm1haW5BcHBEb21haW4iLCJwcm9jZXNzIiwiZW52IiwiTkVYVEFVVEhfVVJMIiwic3BsaXQiLCJpc01haW5Eb21haW4iLCJpbnRlcm5hbE9yaWdpbiIsImRvbWFpbkxvb2t1cFVybCIsIlVSTCIsInNlYXJjaFBhcmFtcyIsInNldCIsInRvU3RyaW5nIiwiZG9tYWluUmVzcG9uc2UiLCJmZXRjaCIsIm9rIiwiZG9tYWluRGF0YSIsImpzb24iLCJzdWNjZXNzIiwib3JnYW5pemF0aW9uIiwicmVxdWVzdEhlYWRlcnMiLCJIZWFkZXJzIiwiX2lkIiwibmFtZSIsInVzZXJPcmdJZCIsIm9yZ2FuaXphdGlvbklkIiwiZG9tYWluT3JnSWQiLCJ2YWxpZGF0ZVVzZXJBY2Nlc3MiLCJzdGFydHNXaXRoIiwibG9naW5VcmwiLCJ1cmwiLCJyZWRpcmVjdCIsImNsb25lIiwib3JnRG9tYWluIiwiZG9tYWluIiwicmV3cml0ZSIsInJlcXVlc3QiLCJkb2N1bWVudElkUGF0dGVybiIsInRlc3QiLCJwdWJsaWNEb2NQYXR0ZXJuIiwiUmVnRXhwIiwibWF0Y2giLCJkb2NJZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnJvciIsIm1lc3NhZ2UiLCJjb2RlIiwic3RhdHVzIiwiY2FsbGJhY2tzIiwiYXV0aG9yaXplZCIsInB1YmxpY1JvdXRlcyIsInByb3RlY3RlZFJvdXRlcyIsInNvbWUiLCJyb3V0ZSIsInJlcXVpcmVzQXV0aCIsInJvbGUiLCJjb25maWciLCJtYXRjaGVyIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(middleware)/./src/middleware.ts\n");

/***/ })

});